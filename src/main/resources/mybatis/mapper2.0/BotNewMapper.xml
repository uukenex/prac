<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="my.prac.core.prjbot.dao.BotNewDAO">

  <!-- 1) Ïú†Ï†Ä -->
  <select id="selectUser" resultType="my.prac.core.game.dto.User">
	 SELECT *
	  FROM (
	      SELECT
	          U.USER_NAME,
	          U.ROOM_NAME,
	          U.LV,
	          U.EXP_CUR,
	          U.EXP_NEXT,
	          U.HP_CUR,
	          U.HP_MAX,
	          U.HP_REGEN,
	          U.ATK_MIN,
	          U.ATK_MAX,
	          U.CRIT_RATE,
	          U.CRIT_DMG,
	          U.TARGET_MON,
	          U.INSERT_DATE,
	          U.JOB,
	          U.JOB_CHANGE_DATE,
	
	          /* üî• Ï†ÑÏ≤¥ ÎàÑÏ†Å SP */
	          NVL(SP_SUM.TOTAL_SP, 0) AS TOTAL_SP
	
	      FROM TBOT_POINT_NEW_USER U
	
	      /* üî• ÎàÑÏ†Å SP ÏßëÍ≥Ñ */
	      LEFT JOIN (
	          SELECT
	              A.USER_NAME,
	              SUM(
	                  CASE
	                      WHEN A.GAIN_TYPE = 'BUY_MERCHANT' THEN
	                          ROUND(B.ITEM_SELL_PRICE * 0.9) * A.QTY
	                      ELSE
	                          B.ITEM_SELL_PRICE * A.QTY
	                  END
	              )
	              + NVL((
	                  SELECT SUM(R.SCORE)
	                  FROM TBOT_POINT_RANK R
	                  WHERE R.NEW_YN = '1'
	                    AND R.USER_NAME = A.USER_NAME
	              ), 0) AS TOTAL_SP
	          FROM TBOT_POINT_NEW_INVENTORY A
	               JOIN TBOT_POINT_NEW_ITEM B
	                 ON A.ITEM_ID = B.ITEM_ID
	          WHERE A.GAIN_TYPE NOT IN ('DROP', 'DROP3', 'DROP5', 'STEAL')
	            AND A.DEL_YN = '0'
	          GROUP BY A.USER_NAME
	      ) SP_SUM
	        ON SP_SUM.USER_NAME = U.USER_NAME
	
	      WHERE U.USER_NAME = #{userName}
		  
	      ORDER BY
	          U.PROC_DATE DESC NULLS LAST,
	          U.INSERT_DATE DESC NULLS LAST,
	          U.LV DESC,
	          U.EXP_CUR DESC
	  )
	  WHERE ROWNUM = 1
	</select>

  <select id="selectAttackDeathStats" resultType="my.prac.core.game.dto.AttackDeathStat">
  /*selectAttackDeathStats*/
    SELECT
      COUNT(*) AS TOTAL_ATTACKS,
      SUM(CASE WHEN DEATH_YN = '1' THEN 1 ELSE 0 END) AS TOTAL_DEATHS
    FROM TBOT_POINT_NEW_BATTLE_LOG
    WHERE USER_NAME = #{userName}
    <!-- 
    <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
      AND ROOM_NAME = #{roomName}
    </if>
    -->
  </select>

  <select id="selectKillStats" resultType="my.prac.core.game.dto.KillStat">
  /*selectKillStats*/
    SELECT bl.TARGET_MON_LV AS MON_NO,
           m.MON_NAME AS MON_NAME,
           COUNT(*) AS KILL_COUNT
    FROM TBOT_POINT_NEW_BATTLE_LOG bl
    JOIN TBOT_POINT_NEW_MON_INFO m ON m.MON_NO = bl.TARGET_MON_LV
    WHERE bl.USER_NAME = #{userName}
    <!-- 
      <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	    AND bl.ROOM_NAME = #{roomName}
	  </if>
	   -->
      AND bl.KILL_YN = 1
    GROUP BY bl.TARGET_MON_LV, m.MON_NAME
    ORDER BY MON_NO DESC
  </select>

  <select id="selectAllMonsters" resultType="my.prac.core.game.dto.Monster">
    SELECT MON_NO, MON_NAME, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_LV,MON_NOTE
    FROM TBOT_POINT_NEW_MON_INFO
    ORDER BY MON_NO
  </select>

  <!-- 2) Î™¨Ïä§ÌÑ∞ -->
  <select id="selectMonsterByNo" resultType="my.prac.core.game.dto.Monster">
  /*selectMonsterByNo*/
    SELECT MON_NO, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_NAME, MON_LV,MON_NOTE
    FROM TBOT_POINT_NEW_MON_INFO
    WHERE MON_NO = #{monNo}
  </select>

  <select id="selectMonsterByName" resultType="my.prac.core.game.dto.Monster">
  /*selectMonsterByName*/
    SELECT MON_NO, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_NAME, MON_LV,MON_NOTE
    FROM TBOT_POINT_NEW_MON_INFO
    WHERE MON_NAME = #{monName}
  </select>

  <!-- 3) ÏßÑÌñâÏ§ë Ï†ÑÌà¨ -->
  <select id="selectOngoingBattle" resultType="my.prac.core.game.dto.OngoingBattle">
  /*selectOngoingBattle*/
    SELECT monNo, totalDealtDmg, luckyYn,beforeJobSkillYn
      FROM (
        SELECT TARGET_MON_LV AS monNo,
               NVL(SUM(ATK_DMG), 0) AS totalDealtDmg,
               MAX(TO_NUMBER(LUCKY_YN)) KEEP (DENSE_RANK LAST ORDER BY INSERT_DATE) AS luckyYn,
               MAX(JOB_SKILL_YN) KEEP (DENSE_RANK LAST ORDER BY INSERT_DATE) AS beforeJobSkillYn,
               MAX(INSERT_DATE) AS lastTime
        FROM TBOT_POINT_NEW_BATTLE_LOG
        WHERE USER_NAME = #{userName}
        <!-- 
          AND ROOM_NAME = #{roomName}
           -->
          AND NOW_YN    = '1'
        GROUP BY TARGET_MON_LV
        ORDER BY lastTime DESC
      )
     WHERE ROWNUM = 1
  </select>

  <!-- 4) ÏµúÏã† Í≥µÍ≤© ÏãúÍ∞Ñ -->
  <select id="selectLastAttackTime" resultType="java.sql.Timestamp">
  /*selectLastAttackTime*/
    SELECT MAX(INSERT_DATE)
    FROM TBOT_POINT_NEW_BATTLE_LOG
    WHERE USER_NAME = #{userName}
    <!-- 
      AND ROOM_NAME = #{roomName}
       -->
  </select>

  <!-- 5) Ï†ÑÌà¨ ÌõÑ Ïú†Ï†Ä ÏóÖÎç∞Ïù¥Ìä∏ -->
  <update id="updateUserAfterBattle">
  /*updateUserAfterBattle*/
    UPDATE TBOT_POINT_NEW_USER
       SET LV        = #{newLv},
           EXP_CUR   = #{newExpCur},
           EXP_NEXT  = #{newExpNext},
           HP_CUR    = #{newHpCur},
           HP_MAX    = #{newHpMax},
           ATK_MIN   = #{newAtkMin},
           ATK_MAX   = #{newAtkMax},
           CRIT_RATE = #{critRate},
           HP_REGEN  = #{hpRegen},
           PROC_DATE = SYSDATE
     WHERE USER_NAME = #{userName}
     <!-- 
       AND ROOM_NAME = #{roomName}
        -->
  </update>

  <!-- 6) Ï†ÑÌà¨ Î°úÍ∑∏ -->
  <insert id="insertBattleLog" parameterType="my.prac.core.game.dto.BattleLog">
  /*insertBattleLog*/
    INSERT INTO TBOT_POINT_NEW_BATTLE_LOG
      (USER_NAME, ROOM_NAME, LV, TARGET_MON_LV,
       GAIN_EXP, ATK_DMG, MON_DMG, ATK_CRIT_YN,
       MON_PATTEN, INSERT_DATE, KILL_YN, NOW_YN, DROP_YN, DEATH_YN, LUCKY_YN, BUFF_YN
       ,JOB_SKILL_YN,JOB
       )
    VALUES
      (#{userName}, #{roomName}, #{lv}, #{targetMonLv},
       #{gainExp}, #{atkDmg}, #{monDmg}, #{atkCritYn},
       #{monPatten}, SYSTIMESTAMP, #{killYn}, #{nowYn}, #{dropYn}, #{deathYn}, #{luckyYn},#{buffYn}
       ,#{jobSkillYn},#{job}
       )
  </insert>

  <!-- 7) Ï†ÑÌà¨ Ï¢ÖÎ£å -->
  <update id="closeOngoingBattle">
  /*closeOngoingBattle*/
    UPDATE TBOT_POINT_NEW_BATTLE_LOG
       SET NOW_YN = '0'
     WHERE USER_NAME = #{userName}
     <!-- 
       AND ROOM_NAME = #{roomName}
        -->
       AND NOW_YN    = '1'
  </update>

  <!-- HPÎßå Í∞±Ïã† -->
  <update id="updateUserHpOnly">
  /*updateUserHpOnly*/
    UPDATE TBOT_POINT_NEW_USER
       SET HP_CUR = #{newHpCur}
     WHERE USER_NAME = #{userName}
     <!-- 
       AND ROOM_NAME = #{roomName}
        -->
  </update>

  <update id="updateUserTargetMon">
  /*updateUserHpOnly*/
    UPDATE TBOT_POINT_NEW_USER
       SET TARGET_MON = #{newMonNo}
     WHERE USER_NAME = #{userName}
     <!-- 
       AND ROOM_NAME = #{roomName}
        -->
  </update>

  <insert id="insertUserWithTarget">
    INSERT INTO TBOT_POINT_NEW_USER
      (USER_NAME, ROOM_NAME, LV, EXP_CUR, EXP_NEXT,
       HP_CUR, HP_MAX, HP_REGEN, ATK_MIN, ATK_MAX,
       CRIT_RATE, CRIT_DMG, INSERT_DATE, TARGET_MON)
    VALUES
      (#{userName}, #{roomName},1, 0, 100,
       10, 10, 2, 1, 5,
       10, 150, SYSDATE, #{targetMonNo})
  </insert>

  <!-- Î≥¥Ï°∞ ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ -->
  <select id="selectParam1ToNewUserSearch" parameterType="HashMap" resultType="String">
	  /*selectParam1ToNewUserSearch*/
	  SELECT A.USER_NAME
	    FROM TBOT_POINT_NEW_USER A
	   WHERE UPPER(A.USER_NAME) LIKE UPPER(#{param1,jdbcType=VARCHAR}) || '%'
	   
	     <!-- Î¨∏ÏùòÎ∞©Ïù¥ ÏïÑÎãê ÎïåÎßå Î∞© Í≥†Ï†ï -->
	     <!-- 
	     <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	       AND A.ROOM_NAME = #{roomName,jdbcType=VARCHAR}
	     </if>
	      -->
	     AND NOT EXISTS (
	         SELECT 1
	           FROM TBOT_BLOCK C
	          WHERE UPPER(C.USER_NAME) = UPPER(#{param1,jdbcType=VARCHAR})
	            <!-- Î∏îÎ°ù Ï≤¥ÌÅ¨ÎèÑ ÎèôÏùº Î∞© Í∏∞Ï§Ä (Î¨∏ÏùòÎ∞©Ïù¥Î©¥ Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ Ìï¥Îãπ Îãâ/Î∞© Ï°∞Ìï© Í∏∞Ï§ÄÏúºÎ°ú ÎèôÏûë) -->
	            <!-- 
	            <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	              AND C.ROOM_NAME = A.ROOM_NAME
	            </if>
	             -->
	     )
	   GROUP BY A.USER_NAME, A.ROOM_NAME
	  HAVING 1 = CASE WHEN MAX(A.PROC_DATE) >= TRUNC(SYSDATE) - 3 THEN 1 ELSE 0 END
	   ORDER BY CASE WHEN LENGTH(#{param1,jdbcType=VARCHAR}) = LENGTH(A.USER_NAME) THEN 1 ELSE 0 END DESC
	</select>

  <!-- ÏµúÍ∑º lucky -->
  <select id="selectLatestLuckyYn" parameterType="map" resultType="int">
  /*selectLatestLuckyYn*/
    SELECT TO_NUMBER(lucky_yn) AS lucky_yn
      FROM (
        SELECT bl.lucky_yn
          FROM TBOT_POINT_NEW_BATTLE_LOG bl
         WHERE bl.user_name = #{userName}
         <!-- 
           AND bl.room_name = #{roomName}
            -->
           AND bl.now_yn    = '1'
         ORDER BY bl.insert_date DESC
      )
     WHERE ROWNUM = 1
  </select>

  <!-- (Ï§ëÎ≥µ Ï†úÍ±∞ÌïòÍ≥† Ïù¥ Ìïú Í∞úÎßå ÎÇ®ÍπÄ) -->
  <select id="selectItemIdByName" parameterType="string" resultType="int">
    SELECT ITEM_ID FROM TBOT_POINT_NEW_ITEM WHERE ITEM_NAME = #{itemName}
  </select>

  <insert id="insertInventoryLog" parameterType="hashmap">
    INSERT INTO TBOT_POINT_NEW_INVENTORY
      (USER_NAME, ROOM_NAME, ITEM_ID, QTY, DEL_YN, GAIN_TYPE, INSERT_DATE)
    VALUES
      (#{userName,jdbcType=VARCHAR},
       #{roomName,jdbcType=VARCHAR},
       #{itemId,jdbcType=NUMERIC},
       #{qty,jdbcType=NUMERIC},
       NVL(#{delYn,jdbcType=VARCHAR}, '0'),
       #{gainType,jdbcType=VARCHAR},
       SYSDATE)
  </insert>

  <!-- ÏùºÎ∞ò ÏöîÏïΩ(ÌåêÎß§Í∞ÄÎä•/Î∂àÍ∞Ä Î∂ÑÎ¶¨ Ïö©) -->
  <select id="selectInventorySummary" resultType="hashmap">
    /*selectInventorySummary*/
    SELECT
	    x.ITEM_ID,
	    CASE WHEN x.GAIN_TYPE = 'DROP3'
	         THEN 'Îπõ' || NVL(t.ITEM_NAME, 'Ïïå Ïàò ÏóÜÏùå')
	         WHEN x.GAIN_TYPE = 'DROP5'
	         THEN 'Ïñ¥Îë†' || NVL(t.ITEM_NAME, 'Ïïå Ïàò ÏóÜÏùå')
	         WHEN x.GAIN_TYPE = 'STEAL'
    		 THEN NVL(t.ITEM_NAME, 'Ïïå Ïàò ÏóÜÏùå') || 'Ï°∞Í∞Å'
	         ELSE NVL(t.ITEM_NAME, 'Ïïå Ïàò ÏóÜÏùå')
	    END AS ITEM_NAME,
	    '1' AS SELLABLE_YN,             -- ÎπõÌÖúÎèÑ ÌåêÎß§ Í∞ÄÎä•
	    x.TOTAL_QTY
	  FROM (
	    SELECT ITEM_ID, GAIN_TYPE, SUM(QTY) AS TOTAL_QTY
	      FROM TBOT_POINT_NEW_INVENTORY
	     WHERE USER_NAME = #{userName}
	     <!-- 
	       <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
		    AND ROOM_NAME = #{roomName}
		   </if>
		    -->
	       AND DEL_YN    = '0'
	     GROUP BY ITEM_ID, GAIN_TYPE
	  ) x
	  LEFT JOIN TBOT_POINT_NEW_ITEM t ON t.ITEM_ID = x.ITEM_ID
	 WHERE x.TOTAL_QTY > 0
	 ORDER BY NVL(t.ITEM_NAME, 'ZZZ'), x.ITEM_ID
  </select>

  <select id="selectInventorySummaryAll" resultType="hashmap">
	/* selectInventorySummaryAll */
	SELECT
	    i.item_id AS ITEM_ID,
	
	    /* üîπ Í∏∞Ï°¥ Ïù¥Î¶Ñ Í∞ÄÍ≥µ Î°úÏßÅ Ïú†ÏßÄ */
	    CASE 
	      WHEN NVL(inv.gain_type,'DROP') = 'DROP3'
	        THEN 'Îπõ' || NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå')
	      WHEN NVL(inv.gain_type,'DROP') = 'DROP5'
	        THEN 'Ïñ¥Îë†' || NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå')
	      WHEN NVL(inv.gain_type,'DROP') = 'STEAL'
	        THEN NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå') || 'Ï°∞Í∞Å'
	      ELSE NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå')
	    END AS ITEM_NAME,
	
	    SUM(inv.qty) AS TOTAL_QTY,
	
	    /* üîπ Í∏∞Ï°¥ Ïª¨Îüº */
	    NVL(MAX(i.item_sell_price), 0) AS ITEM_SELL_PRICE,
	    NVL(MAX(i.item_type), '')      AS ITEM_TYPE,
	
	    /* üî• ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ ÏòµÏÖò (Ï∂îÍ∞Ä) */
	    NVL(MAX(i.ATK_MIN), 0)        AS ATK_MIN,
	    NVL(MAX(i.ATK_MAX), 0)        AS ATK_MAX,
	    NVL(MAX(i.ATK_CRI), 0)        AS ATK_CRI,
	    NVL(MAX(i.HP_REGEN), 0)       AS HP_REGEN,
	    NVL(MAX(i.HP_MAX), 0)         AS HP_MAX,
	    NVL(MAX(i.CRI_DMG), 0)        AS CRI_DMG,
	    NVL(MAX(i.HP_MAX_RATE), 0)    AS HP_MAX_RATE,
	    NVL(MAX(i.ATK_MAX_RATE), 0)   AS ATK_MAX_RATE
	
	FROM TBOT_POINT_NEW_INVENTORY inv
	LEFT JOIN TBOT_POINT_NEW_ITEM i
	  ON i.item_id = inv.item_id
	
	WHERE inv.user_name = #{userName}
	  AND inv.del_yn = '0'
	  AND inv.item_id > 90
	GROUP BY
	    i.item_id, -1,
	    CASE 
	      WHEN NVL(inv.gain_type,'DROP') = 'DROP3'
	        THEN 'Îπõ' || NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå')
	      WHEN NVL(inv.gain_type,'DROP') = 'DROP5'
	        THEN 'Ïñ¥Îë†' || NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå')
	      WHEN NVL(inv.gain_type,'DROP') = 'STEAL'
	        THEN NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå') || 'Ï°∞Í∞Å'
	      ELSE NVL(i.item_name, 'Ïïå Ïàò ÏóÜÏùå')
	    END
	
	ORDER BY i.item_id
	</select>


  <select id="selectCurrentPoint" resultType="int">
    SELECT NVL(SUM(score), 0)
      FROM TBOT_POINT_RANK
     WHERE user_name = #{userName}
       
       AND new_yn = '1'
  </select>

  <!-- ÌåêÎß§ ÎåÄÏÉÅ Ìñâ(FIFO) : ÎπõÎÇòÎäî Ï†úÏô∏ -->
  <select id="selectInventoryRowsForSale" resultType="hashmap">
    SELECT ROWID AS RID, QTY, NVL(GAIN_TYPE,'DROP') AS GAIN_TYPE
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
     <!-- 
       AND ROOM_NAME = #{roomName}
        -->
       AND ITEM_ID   = #{itemId}
       AND NVL(DEL_YN,'0') != '1'
     ORDER BY INSERT_DATE ASC, ROWID
  </select>
  <!-- ÌåêÎß§ ÎåÄÏÉÅ Ìñâ(FIFO) : ÎπõÎÇòÎäî Ï†úÏô∏ -->
  <select id="selectAllInventoryRowsForSale" resultType="hashmap">
    SELECT ROWID AS RID, QTY, NVL(GAIN_TYPE,'DROP') AS GAIN_TYPE
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
     <!-- 
       AND ROOM_NAME = #{roomName}
        -->
       AND NVL(DEL_YN,'0') != '1'
     ORDER BY INSERT_DATE ASC, ROWID
  </select>

  <update id="updateInventoryDelByRowId">
    UPDATE TBOT_POINT_NEW_INVENTORY SET DEL_YN = '1' WHERE ROWID = #{rid}
  </update>

  <update id="updateInventoryQtyByRowId">
    UPDATE TBOT_POINT_NEW_INVENTORY SET QTY = #{newQty} WHERE ROWID = #{rid}
  </update>


  <select id="selectItemSellPriceById" resultType="int">
    SELECT NVL(ITEM_SELL_PRICE,0)
      FROM TBOT_POINT_NEW_ITEM
     WHERE ITEM_ID = #{itemId}
  </select>

  <!-- Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω -->
  <insert id="insertPointRank" parameterType="hashmap">
    INSERT INTO TBOT_POINT_RANK
      (USER_NAME, ROOM_NAME, SCORE, INSERT_DATE, CMD, NEW_YN)
    VALUES
      (#{userName}, #{roomName}, #{score}, SYSDATE, #{cmd}, '1')
  </insert>

  <select id="selectItemPriceByName" parameterType="string" resultType="int">
    SELECT NVL(item_sell_price,0)
      FROM TBOT_POINT_NEW_ITEM
     WHERE item_name = #{itemName}
  </select>

  
  <select id="selectOwnedMarketBuffTotals" resultType="map">
	  SELECT
	      	NVL(SUM( ROUND(i.atk_min  * 
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6            -- qty >= 4
		        END
		    )), 0) AS ATK_MIN,
		    NVL(SUM( ROUND(i.atk_max  * 
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS ATK_MAX,
		    NVL(SUM( ROUND(i.atk_cri  *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS ATK_CRI,
		    NVL(SUM( ROUND(i.hp_regen *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS HP_REGEN,
		    NVL(SUM( ROUND(i.hp_max   *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS HP_MAX,
		    NVL(SUM( ROUND(i.cri_dmg  *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS CRI_DMG,
		    NVL(SUM( ROUND(i.hp_max_rate  *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS HP_MAX_RATE,
		    NVL(SUM( ROUND(i.atk_max_rate  *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS ATK_MAX_RATE
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  JOIN TBOT_POINT_NEW_ITEM i
	    ON i.item_id = inv.item_id
	  WHERE inv.user_name = #{userName}
	  <!-- 
	    <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	    AND inv.room_name = #{roomName}
	   </if>
	   -->
	    AND inv.del_yn = '0'
	    AND i.item_type in ('MARKET','BAG_OPEN','MASTER','ACHV')
	</select>
	
	<!-- Íµ¨Îß§ Í∞ÄÎä•Ìïú MARKET ÏïÑÏù¥ÌÖú Î™©Î°ù + Î≥¥Ïú†Ïó¨Î∂Ä -->
	<select id="selectMarketItemsForSale" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg,
	      CASE
	        WHEN EXISTS (
	          SELECT 1
	            FROM TBOT_POINT_NEW_INVENTORY inv
	           WHERE inv.user_name = #{userName}
	           <!-- 
	             AND inv.room_name = #{roomName}
	              -->
	             AND inv.item_id   = i.item_id
	             AND inv.del_yn    = '0'
	        ) THEN 'Y' ELSE 'N'
	      END AS owned_yn
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	  ORDER BY i.item_id
	</select>
	
	<!-- MARKET Îã®Ïùº: ITEM_ID Í∏∞Ï§Ä -->
	<select id="selectMarketItemById" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	    AND i.item_id   = #{itemId}
	</select>
	
	<!-- Î≥¥Ïú†Ï§ëÏù∏ MARKET Ïù∏Î≤§ÌÜ†Î¶¨ ÏàòÎüâ(ÌôúÏÑ±Ìñâ) -->
	<select id="countOwnedMarketItem" resultType="int">
	  SELECT NVL(SUM(inv.qty),0)
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  WHERE inv.user_name = #{userName}
	  <!-- 
	    AND inv.room_name = #{roomName}
	     -->
	    AND inv.item_id   = #{itemId}
	    AND inv.del_yn    = '0'
	</select>
	
	
	<select id="selectMarketItems" resultType="hashmap">
	    SELECT 
	        i.ITEM_ID,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,   0) AS ATK_MIN,
	        NVL(i.ATK_MAX,   0) AS ATK_MAX,
	        NVL(i.ATK_CRI,   0) AS ATK_CRI,
	        NVL(i.HP_REGEN,  0) AS HP_REGEN,
	        NVL(i.HP_MAX,    0) AS HP_MAX,
	        NVL(i.CRI_DMG,   0) AS CRI_DMG,
	        NVL(i.HP_MAX_RATE,   0) AS HP_MAX_RATE,
	        NVL(i.ATK_MAX_RATE,   0) AS ATK_MAX_RATE
	    FROM TBOT_POINT_NEW_ITEM i
	    WHERE i.ITEM_TYPE = 'MARKET'
	    ORDER BY i.ITEM_ID
	</select>
	
	<!--  B. ÏïÑÏù¥ÌÖú Îã®Í±¥ ÏÉÅÏÑ∏  -->
	<select id="selectItemDetailById" resultType="hashmap">
		/*selectItemDetailById*/
	    SELECT 
	        i.ITEM_ID,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,   0) AS ATK_MIN,
	        NVL(i.ATK_MAX,   0) AS ATK_MAX,
	        NVL(i.ATK_CRI,   0) AS ATK_CRI,
	        NVL(i.HP_REGEN,  0) AS HP_REGEN,
	        NVL(i.HP_MAX,    0) AS HP_MAX,
	        NVL(i.CRI_DMG,   0) AS CRI_DMG,
	        NVL(i.HP_MAX_RATE,   0) AS HP_MAX_RATE,
	        NVL(i.ATK_MAX_RATE,   0) AS ATK_MAX_RATE
	    FROM TBOT_POINT_NEW_ITEM i
	    WHERE i.ITEM_ID = #{itemId}
	</select>
	
	
	<!--  D. Ïù∏Î≤§ÌÜ†Î¶¨ Î≥¥Ïú† ÏàòÎüâ Ìï©(DEL_YN='0'Îßå)  -->
	<select id="selectInventoryQty" resultType="int">
		/*selectInventoryQty*/
	    SELECT NVL(SUM(n.QTY), 0)
	    FROM TBOT_POINT_NEW_INVENTORY n
	    WHERE n.USER_NAME = #{userName}
	    <!-- 
	      AND n.ROOM_NAME = #{roomName}
	       -->
	      AND n.ITEM_ID   = #{itemId}
	      AND NVL(n.DEL_YN, '0') = '0'
	</select>
	<!-- MARKET ÏïÑÏù¥ÌÖú Ï†ÑÏ≤¥ + Î≥¥Ïú†Ïó¨Î∂Ä(OWNED_YN) -->
	<select id="selectMarketItemsWithOwned" resultType="hashmap">
	    SELECT
	        i.ITEM_ID,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,0)   AS ATK_MIN,
	        NVL(i.ATK_MAX,0)   AS ATK_MAX,
	        NVL(i.ATK_CRI,0)   AS ATK_CRI,
	        NVL(i.HP_REGEN,0)  AS HP_REGEN,
	        NVL(i.HP_MAX,0)    AS HP_MAX,
	        NVL(i.CRI_DMG,0)   AS CRI_DMG,
	        NVL(i.HP_MAX_RATE,0)   AS HP_MAX_RATE,
	        NVL(i.ATK_MAX_RATE,0)   AS ATK_MAX_RATE,
	
	        NVL(inv.OWN_QTY, 0) AS OWN_QTY,
	
	        CASE WHEN NVL(inv.OWN_QTY, 0) > 0 THEN 'Y' ELSE 'N' END AS OWNED_YN,
	
	        CASE
	            WHEN i.ITEM_ID BETWEEN 100 AND 199
	              OR i.ITEM_ID BETWEEN 200 AND 299
	              OR i.ITEM_ID BETWEEN 400 AND 499
	            THEN
	                CASE
	                    WHEN NVL(inv.OWN_QTY, 0) >= 1 THEN 'Y'  
	                    ELSE 'N'
	                END
	            ELSE
	                CASE
	                    WHEN NVL(inv.OWN_QTY, 0) >= 1 THEN 'Y'
	                    ELSE 'N'
	                END
	        END AS MAXED_YN,
	        I.INSERT_DATE
	
	    FROM TBOT_POINT_NEW_ITEM i
	
	    LEFT JOIN (
	        SELECT
	            inv.ITEM_ID,
	            inv.USER_NAME,
	            inv.ROOM_NAME,
	            SUM(inv.QTY) AS OWN_QTY
	        FROM TBOT_POINT_NEW_INVENTORY inv
	        WHERE inv.DEL_YN = '0'
	        GROUP BY inv.ITEM_ID, inv.USER_NAME, inv.ROOM_NAME
	    ) inv
	      ON inv.ITEM_ID   = i.ITEM_ID
	     AND inv.USER_NAME = #{userName}
	     <!-- 
	     <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	       AND inv.ROOM_NAME = #{roomName}
	     </if>
	 	-->
	    WHERE i.ITEM_TYPE = 'MARKET'
	    ORDER BY i.ITEM_ID desc
	</select>

	
	<!-- Ïù¥ÎØ∏ ÏÜåÏú†Ìïú MARKET ÏïÑÏù¥ÌÖúÏù∏ÏßÄ ÌôïÏù∏ -->
	<select id="selectHasOwnedMarketItem" resultType="int">
	  SELECT COUNT(1)
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  WHERE inv.USER_NAME = #{userName}
	  <!-- 
	 	<if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	    AND inv.ROOM_NAME = #{roomName}
	   </if>
	    -->
	    AND inv.ITEM_ID   = #{itemId}
	    AND inv.DEL_YN    = '0'
	</select>
	
	<!-- ÎßàÏßÄÎßâÏúºÎ°ú 'ÌîºÌï¥Î•º Î∞õÏùÄ' ÏãúÍ∞Å: MON_DMG>0 ÎòêÎäî DEATH_YN='1' -->
	<select id="selectLastDamagedTime" resultType="java.sql.Timestamp">
	  SELECT MAX(
	           INSERT_DATE
	           + CASE 
	               WHEN DEATH_YN = '1' 
	                 THEN (5 / 24 / 60)  -- 10Î∂Ñ = 10/24/60 Ïùº
	               ELSE 0
	             END
	         )
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	   WHERE USER_NAME = #{userName}
	   <!-- 
	   <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	     AND ROOM_NAME = #{roomName}
	   </if>
	    -->
	     AND (MON_DMG > 0 OR DEATH_YN = '1')
	</select>
	
	<select id="selectTopLevelUsers" resultType="hashmap">
	  SELECT USER_NAME, LV, EXP_CUR, EXP_NEXT, JOB
	  FROM (
	    SELECT u.USER_NAME, u.LV, u.EXP_CUR, u.EXP_NEXT, U.JOB,
	           ROW_NUMBER() OVER (ORDER BY u.LV DESC, u.EXP_CUR DESC, u.USER_NAME ASC) AS RN
	      FROM TBOT_POINT_NEW_USER u
	      WHERE U.PROC_DATE > SYSDATE-3
	  )
	  WHERE RN &lt;= 7
	  ORDER BY RN
	</select>
	
	<!-- ‚ë° Î™¨Ïä§ÌÑ∞Î≥Ñ ÌïôÏÇ¥Ïûê (ÌÇ¨ 50 Ïù¥ÏÉÅ, ÎèôÎ•† ÌóàÏö©) -->
	<select id="selectKillLeadersByMonster" resultType="hashmap">
	  SELECT MON_NO, MON_NAME, USER_NAME, KILL_COUNT
	  FROM (
	    SELECT
	      bl.TARGET_MON_LV AS MON_NO,
	      m.MON_NAME       AS MON_NAME,
	      bl.USER_NAME     AS USER_NAME,
	      COUNT(*)         AS KILL_COUNT,
	      DENSE_RANK() OVER (
	        PARTITION BY bl.TARGET_MON_LV
	        ORDER BY COUNT(*) DESC
	      ) AS RNK
	    FROM TBOT_POINT_NEW_BATTLE_LOG bl
	    JOIN TBOT_POINT_NEW_MON_INFO m
	      ON m.MON_NO = bl.TARGET_MON_LV
	    WHERE bl.KILL_YN   = 1
	    GROUP BY bl.TARGET_MON_LV, m.MON_NAME, bl.USER_NAME
	  )
	  WHERE RNK = 1
	    AND KILL_COUNT >= 50
	  ORDER BY MON_NO, USER_NAME
	</select>
	
	<!-- ‚ë¢ ÏµúÏ¥à ÌÜ†Î≤åÏûê Ï†ïÎ≥¥ -->
	<select id="selectFirstClearInfo" resultType="hashmap">
	  SELECT
	      m.MON_NO,
	      m.MON_NAME,
	      m.MON_LV,
	      fc.FIRST_CLEAR_USER,
	      TO_CHAR(fc.FIRST_CLEAR_DATE, 'YYYY-MM-DD HH24:MI') AS FIRST_CLEAR_DATE
	  FROM TBOT_POINT_NEW_MON_INFO m
	  LEFT JOIN (
	    SELECT
	        bl.TARGET_MON_LV AS MON_NO,
	        MIN(bl.INSERT_DATE) AS FIRST_CLEAR_DATE,
	        MIN(bl.USER_NAME) KEEP (DENSE_RANK FIRST ORDER BY bl.INSERT_DATE) AS FIRST_CLEAR_USER
	    FROM TBOT_POINT_NEW_BATTLE_LOG bl
	    WHERE bl.KILL_YN = 1
	    GROUP BY bl.TARGET_MON_LV
	  ) fc ON fc.MON_NO = m.MON_NO
	  WHERE fc.FIRST_CLEAR_USER IS NOT NULL
	  ORDER BY m.MON_NO
	</select>
	
	
	
		<!-- ÌäπÏ†ï Î∞©ÏóêÏÑú ÌäπÏ†ï Ïú†Ï†ÄÍ∞Ä ÌäπÏ†ï ÏóÖÏ†Å CMDÎ°ú Ïù¥ÎØ∏ Î≥¥ÏÉÅÎ∞õÏïòÎäîÏßÄ -->
	<select id="selectPointRankCountByCmdUserInRoom" parameterType="hashMap" resultType="int">
	    SELECT COUNT(1)
	    FROM TBOT_POINT_RANK
	    WHERE USER_NAME = #{userName}
	      <!-- 
	      AND ROOM_NAME = #{roomName}
	       -->
	      AND CMD = #{cmd}
	      AND NEW_YN = '1'
	</select>
	
	<select id="selectPointRankCountByCmdGlobal" resultType="int">
	/*selectPointRankCountByCmdGlobal*/
	   SELECT COUNT(1)
	     FROM TBOT_POINT_RANK
	    WHERE CMD = #{cmd}
	      AND NEW_YN = '1'
	</select>
	<select id="selectAchvCountsGlobalAll" resultType="my.prac.core.game.dto.AchievementCount">
	    /*selectAchvCountsGlobalAll*/
	    SELECT CMD,
	           COUNT(1) AS CNT
	      FROM TBOT_POINT_RANK
	     WHERE NEW_YN = '1'
	       AND CMD LIKE 'ACHV_%'
	       AND CMD NOT LIKE '%BROAD%'
	     GROUP BY CMD
	</select>
	
	<select id="selectAchievementsByUser" resultType="hashMap" parameterType="string">
	/*selectAchievementsByUser*/
	  SELECT CMD, SCORE, USER_NAME, ROOM_NAME, INSERT_DATE
	  FROM TBOT_POINT_RANK
	  WHERE USER_NAME = #{userName}
	    AND CMD LIKE 'ACHV_%'
	    AND CMD NOT LIKE '%BROAD%'
	  ORDER BY CASE
			        WHEN CMD LIKE 'ACHV_FIRST_CLEAR_MON_%' THEN 1
			        WHEN CMD LIKE 'ACHV_KILL_TOTAL_%'      THEN 2
			        WHEN CMD LIKE 'ACHV_KILL%_MON_%'       THEN 3
			        WHEN CMD LIKE 'ACHV_DEATH%'       	   THEN 4
			        ELSE 9
			    END,
			    -- 2ÏàúÏúÑ: Î™¨Ïä§ÌÑ∞Î≤àÌò∏ or Ï¥ùÌÇ¨Ï°∞Í±¥ Ïà´Ïûê(Í∞Å Ìå®ÌÑ¥Ïóê ÎßûÍ≤å)
			    CASE
			        WHEN CMD LIKE 'ACHV_FIRST_CLEAR_MON_%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))
			        WHEN CMD LIKE 'ACHV_KILL_TOTAL_%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))
			        WHEN CMD LIKE 'ACHV_KILL%_MON_%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))  -- MON_Îí§ Ïà´Ïûê (Î™¨Ïä§ÌÑ∞ Î≤àÌò∏)
			        WHEN CMD LIKE 'ACHV_DEATH%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))
			        ELSE NULL
			    END,
			    -- 3ÏàúÏúÑ: Í∞ôÏùÄ MONÏóêÏÑú 50 ‚Üí 100 Ïàú
			    CASE
			        WHEN CMD LIKE 'ACHV_KILL50_MON_%'  THEN 1
			        WHEN CMD LIKE 'ACHV_KILL100_MON_%' THEN 2
			        ELSE 0
			    END
	</select>
	
	<select id="selectDailyAttackCounts" parameterType="hashmap" resultType="hashmap">
		/*selectDailyAttackCounts*/
	    SELECT TRUNC(INSERT_DATE) AS ATTACK_DAY,
	           COUNT(1)            AS ATK_CNT
	      FROM TBOT_POINT_NEW_BATTLE_LOG
	     WHERE USER_NAME = #{userName}
	       AND INSERT_DATE &lt; SYSDATE
	     GROUP BY TRUNC(INSERT_DATE)
	     ORDER BY ATTACK_DAY
	</select>
	
	<select id="selectBattleCountByUser" parameterType="hashmap" resultType="hashmap">
		/*selectBattleCountByUser*/
	    SELECT NVL(JOB,'Ï¥àÎ≥¥Ïûê') AS JOB,
	           COUNT(1) AS CNT
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	    WHERE USER_NAME = #{userName}
	    GROUP BY JOB
	</select>
 
	<update id="updateUserJobAndChangeDate">
	/*updateUserJobAndChangeDate*/
	    UPDATE TBOT_POINT_NEW_USER
	       SET JOB = #{job},
	           JOB_CHANGE_DATE = SYSDATE
	     WHERE USER_NAME = #{userName}
	</update>
	
	<select id="selectRisingStarsTop5Last6h" resultType="hashmap">
	/*selectRisingStarsTop5Last6h*/
	    SELECT *
	    FROM (
	        SELECT USER_NAME,
	               ROOM_NAME,
	               (SELECT U.JOB
					   FROM TBOT_POINT_NEW_USER U
					  WHERE U.USER_NAME = A.USER_NAME
					    AND ROWNUM=1) AS JOB,
	               COUNT(*) AS ATK_CNT,
	               MAX(INSERT_DATE) AS LAST_ATTACK
	        FROM TBOT_POINT_NEW_BATTLE_LOG A
	        WHERE INSERT_DATE >= SYSDATE - (3/24)
	          AND ROOM_NAME NOT IN ('ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©','test123')
	        GROUP BY USER_NAME, ROOM_NAME
	        ORDER BY ATK_CNT DESC, LAST_ATTACK DESC
	    )
	    WHERE ROWNUM &lt;= 10
	</select>
	
	<select id="selectSpAndAtkRanking" resultType="hashmap">
	    SELECT SUM(
	               CASE
	                   WHEN A.GAIN_TYPE = 'BUY_MERCHANT' THEN
	                       ROUND(B.ITEM_SELL_PRICE * 0.9) * A.QTY
	                   ELSE
	                       B.ITEM_SELL_PRICE * A.QTY
	               END
	           )
	           + (
	               SELECT SUM(A1.SCORE)
	                 FROM TBOT_POINT_RANK A1
	                WHERE A1.NEW_YN    = '1'
	                  AND A1.USER_NAME = A.USER_NAME
	                  <!-- 
	                  AND A1.ROOM_NAME = A.ROOM_NAME
	                   -->
	             ) AS TOT_SP,
	           A.USER_NAME,
	           A.ROOM_NAME,
	           (
	               SELECT COUNT(1)
	                 FROM TBOT_POINT_NEW_BATTLE_LOG A2
	                WHERE A2.USER_NAME = A.USER_NAME
	                  <!-- 
	                  AND A2.ROOM_NAME = A.ROOM_NAME
	                   -->
	           ) AS ATK_CNT,
	           (
	                 SELECT COUNT(1)
	                   FROM TBOT_POINT_NEW_BATTLE_LOG A2
	                  WHERE A2.USER_NAME = A.USER_NAME
	                    <!-- 
	                    AND A2.ROOM_NAME = A.ROOM_NAME
	                     -->
	                    AND A2.DEATH_YN = '1'
	            ) AS DEATH_CNT,
	           C.LV
	      FROM TBOT_POINT_NEW_INVENTORY A,
	           TBOT_POINT_NEW_ITEM      B,
	           TBOT_POINT_NEW_USER      C
	     WHERE A.GAIN_TYPE NOT IN ('DROP', 'DROP3', 'DROP5', 'STEAL')
	       AND A.ITEM_ID   = B.ITEM_ID
	       AND A.DEL_YN    = '0'
	       AND C.USER_NAME = A.USER_NAME
	       <!-- 
	       AND C.ROOM_NAME = A.ROOM_NAME
	        -->
	     GROUP BY A.USER_NAME, A.ROOM_NAME, C.LV
	     ORDER BY TOT_SP DESC
	</select>
	
	<select id="selectOngoingChallengesForUnclearedBosses" resultType="hashmap">
	/*selectOngoingChallengesForUnclearedBosses*/
	  SELECT
	      ob.TARGET_MON_LV          AS MON_NO,
	      m.MON_NAME                AS MON_NAME,
	      ob.USER_NAME              AS USER_NAME,
	      u.JOB                     AS JOB,
	      u.LV                      AS LV,
	      TO_CHAR(ob.START_TIME, 'YYYY-MM-DD HH24:MI:SS') AS START_TIME,
	      m.MON_HP                  AS MON_HP,
	      GREATEST(m.MON_HP - ob.TOTAL_ATK, 0) AS REMAIN_HP
	  FROM (
	      SELECT
	          bl.USER_NAME,
	          bl.ROOM_NAME,
	          bl.TARGET_MON_LV,
	          MIN(bl.INSERT_DATE)         AS START_TIME,
	          NVL(SUM(bl.ATK_DMG), 0)     AS TOTAL_ATK
	      FROM TBOT_POINT_NEW_BATTLE_LOG bl
	      WHERE bl.NOW_YN = '1'
	      GROUP BY bl.USER_NAME, bl.ROOM_NAME, bl.TARGET_MON_LV
	  ) ob
	  JOIN TBOT_POINT_NEW_MON_INFO m
	    ON m.MON_NO = ob.TARGET_MON_LV
	  JOIN TBOT_POINT_NEW_USER u
	    ON u.USER_NAME = ob.USER_NAME
	   <!-- 
	   AND u.ROOM_NAME = ob.ROOM_NAME
	    -->
	  WHERE NOT EXISTS (
	        SELECT 1
	          FROM TBOT_POINT_NEW_BATTLE_LOG b2
	         WHERE b2.TARGET_MON_LV = ob.TARGET_MON_LV
	           AND b2.KILL_YN = 1
	    )
	  ORDER BY m.MON_NO, ob.START_TIME, ob.USER_NAME
	</select>
	
	<!-- ÎèÑÏÇ¨ Î≤ÑÌîÑ ÌôïÏù∏ (Î∞© Ï†ÑÏ≤¥ 1ÌöåÏö© Î≤ÑÌîÑ Ï°¥Ïû¨ Ïó¨Î∂Ä) -->
	<select id="selectRoomBuffCount" parameterType="string" resultType="int">
	    SELECT COUNT(1)
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	    WHERE ROOM_NAME = #{roomName}
	      AND BUFF_YN = '1'
	</select>
	
	<!-- ÎèÑÏÇ¨ Î≤ÑÌîÑ Î¶¨ÏÖã (1Ìöå ÏÇ¨Ïö© ÌõÑ 0ÏúºÎ°ú Ï¥àÍ∏∞Ìôî) -->
	<update id="clearRoomBuff" parameterType="string">
	    UPDATE TBOT_POINT_NEW_BATTLE_LOG
	       SET BUFF_YN = '0'
	     WHERE ROOM_NAME = #{roomName}
	       AND BUFF_YN = '1'
	</update>
	
	<select id="selectDosaBuffInfo" parameterType="string" resultType="hashmap">
	    /*selectDosaBuffInfo*/
	    SELECT USER_NAME,
	           LV,
	           INSERT_DATE
	      FROM TBOT_POINT_NEW_BATTLE_LOG
	     WHERE ROOM_NAME = #{roomName}
	       AND BUFF_YN = '1'
	       and rownum=1
	     ORDER BY INSERT_DATE DESC
	</select>
	
	<select id="selectItemIdByRowId" parameterType="string" resultType="int">
	    SELECT ITEM_ID
	      FROM TBOT_POINT_NEW_INVENTORY
	     WHERE ROWID = #{rid}
	</select>
	
	<select id="selectTotalEarnedSp" resultType="int">
	SELECT (SELECT SUM(A.SCORE)
	          FROM TBOT_POINT_RANK A
	         WHERE A.NEW_YN = '1'
	           AND A.USER_NAME = #{userName}
	           <!-- 
	           <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	           AND ROOM_NAME = #{roomName}
	           </if>
	            -->
	           ) +
	       (SELECT SUM(CASE
	                     WHEN A.GAIN_TYPE = 'BUY_MERCHANT' THEN
	                      ROUND(B.ITEM_SELL_PRICE * 0.9)*A.QTY
	                     ELSE
	                      B.ITEM_SELL_PRICE*A.QTY
	                   END)
	          FROM TBOT_POINT_NEW_INVENTORY A, TBOT_POINT_NEW_ITEM B
	         WHERE A.USER_NAME LIKE #{userName}
	         <!-- 
	         <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	           AND ROOM_NAME = #{roomName}
	         </if>
	          -->
	           AND A.GAIN_TYPE NOT IN ('DROP', 'DROP3','DROP5', 'STEAL')
	           AND A.ITEM_ID = B.ITEM_ID
	           AND DEL_YN = '0')
	  FROM DUAL
	  </select>
	  
	  <select id="selectThiefKingRanking" parameterType="string" resultType="hashmap">
	    SELECT *
	    FROM (
	        SELECT USER_NAME,
	               ROOM_NAME,
	               SUM(QTY) AS STEAL_QTY
	          FROM TBOT_POINT_NEW_INVENTORY
	         WHERE NVL(GAIN_TYPE, 'DROP') = 'STEAL'
	         GROUP BY USER_NAME, ROOM_NAME
	         ORDER BY SUM(QTY) DESC, USER_NAME
	    )
	    WHERE ROWNUM &lt;= 5
	</select>
	
	
	<select id="selectAchievementCountRanking" parameterType="string" resultType="hashmap">
	    SELECT *
		    FROM (
		        SELECT USER_NAME,
		               ROOM_NAME,
		               COUNT(*) AS ACHV_CNT
		          FROM TBOT_POINT_RANK
		         WHERE NEW_YN = '1'
		           AND CMD LIKE 'ACHV%'
		           AND CMD NOT LIKE '%BROAD%'
		         GROUP BY USER_NAME, ROOM_NAME
		         ORDER BY COUNT(*) DESC, USER_NAME
		    )
		    WHERE ROWNUM &lt;= 5
	</select>
	
	<select id="selectActiveMonster" parameterType="hashmap" resultType="hashmap">
	  SELECT *
	    FROM (
	        SELECT 
	               b.TARGET_MON_LV,
	               mi.MON_NAME,
	               mi.MON_HP       AS MON_MAX_HP
	          FROM TBOT_POINT_NEW_BATTLE_LOG b
	          JOIN TBOT_POINT_NEW_MON_INFO mi
	            ON b.TARGET_MON_LV = mi.MON_NO     <!-- Î™¨Ïä§ÌÑ∞ Î†àÎ≤®/Î≤àÌò∏ Îß§Ìïë -->
	         WHERE b.USER_NAME = #{userName}
	           <!-- 
	           AND b.ROOM_NAME = #{roomName}
	            -->
	           AND NVL(b.NOW_YN, '1') = '1'        <!-- ÌòÑÏû¨ ÏßÑÌñâÏ§ë Ï†ÑÌà¨ -->
	           AND NVL(b.KILL_YN, '0') = '0'       <!-- ÏïÑÏßÅ Ïïà Ï£ΩÏùÄ Î™¨Ïä§ÌÑ∞ -->
	         ORDER BY b.INSERT_DATE DESC           <!-- Í∞ÄÏû• ÏµúÍ∑º Ï†ÑÌà¨ Î°úÍ∑∏ -->
	    )
	    WHERE ROWNUM = 1
	</select>
	
	<select id="selectAchvCountsGlobal" resultType="my.prac.core.game.dto.AchievementCount">
	    SELECT CMD,
	           COUNT(1) AS CNT
	      FROM TBOT_POINT_RANK
	     WHERE NEW_YN = '1'
	     <!-- 
	       <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
           AND ROOM_NAME = #{roomName}
	       </if>
	        -->
	       AND USER_NAME = #{userName}
	       AND CMD LIKE 'ACHV_%'
	     GROUP BY CMD
	</select>
	
	<update id="execSPMsgTest" statementType="CALLABLE" parameterType="hashMap">
		{call SP_MSG_TEST ( #{outCode  , jdbcType=NUMERIC,mode=INOUT},
						 	#{outMsg   , jdbcType=VARCHAR,mode=INOUT}
							)
		}
	</update>
	<update id="execSPPatchNoteTest" statementType="CALLABLE" parameterType="hashMap">
		{call SP_PATCH_NOTE_TEST ( #{outCode  , jdbcType=NUMERIC,mode=INOUT},
								   #{outMsg   , jdbcType=VARCHAR,mode=INOUT}
								  )
		}
	</update>
		
		
	<select id="selectBagCount" resultType="int">
    SELECT NVL(SUM(QTY), 0)
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
       <!-- 
       AND ROOM_NAME = #{roomName}
        -->
       AND ITEM_ID   = #{itemId}
       AND DEL_YN    = '0'
	</select>
	
	<!-- 2) Í∞ÄÎ∞© 1Í∞ú ÏÜåÎπÑ: Í∞ÄÏû• Î®ºÏ†Ä Îì§Ïñ¥Ïò® 1Í∞úÎ•º del_yn='1'Î°ú -->
	<update id="consumeOneBag" parameterType="hashmap">
	    UPDATE TBOT_POINT_NEW_INVENTORY
	       SET DEL_YN = '1'
	     WHERE USER_NAME = #{userName}
	     <!-- 
	       AND ROOM_NAME = #{roomName}
	        -->
	       AND ITEM_ID   = #{itemId}
	       AND DEL_YN    = '0'
	       AND ROWNUM    = 1
	</update>
	
	<select id="selectBagRewardItemIds" resultType="int">
	    SELECT ITEM_ID
	      FROM TBOT_POINT_NEW_ITEM
	     WHERE ITEM_TYPE = 'SELL'
	</select>
	
	<!-- 4) ÏïÑÏù¥ÌÖú Ïù¥Î¶Ñ Ï°∞Ìöå -->
	<select id="selectItemNameById" resultType="string">
	    SELECT ITEM_NAME
	      FROM TBOT_POINT_NEW_ITEM
	     WHERE ITEM_ID = #{itemId}
	</select>
	
	<select id="selectBagRewardItemIdsUserNotOwned" parameterType="hashmap" resultType="int">
    SELECT ITEM_ID
      FROM TBOT_POINT_NEW_ITEM I
     WHERE I.ITEM_TYPE = 'BAG_OPEN'
       AND I.ITEM_ID NOT IN (
           SELECT DISTINCT ITEM_ID
             FROM TBOT_POINT_NEW_INVENTORY
            WHERE USER_NAME = #{userName}
              <!-- 
              AND ROOM_NAME = #{roomName}
               -->
              AND DEL_YN = '0'
       )
	</select>

	<select id="selectRecentBagDrops" resultType="my.prac.core.game.dto.BagLog">
	    SELECT *
		  FROM (
		      SELECT 
		          USER_NAME AS userName,
		          ROOM_NAME AS roomName,
		          INSERT_DATE AS insertDate
		      FROM TBOT_POINT_NEW_INVENTORY
		      WHERE ITEM_ID = 91     -- Í∞ÄÎ∞©
		      ORDER BY INSERT_DATE DESC
		  )
		  WHERE ROWNUM &lt;= 5
	</select>
	
	<select id="selectRecentBagRewards"
        resultType="my.prac.core.game.dto.BagRewardLog">
	    SELECT *
	    FROM (
	        SELECT gain,
	               userName,
	               roomName,
	               insertDate
	        FROM (
	            SELECT TO_CHAR(C.SCORE) || ' sp' AS gain,
	                   C.USER_NAME               AS userName,
	                   C.ROOM_NAME               AS roomName,
	                   C.INSERT_DATE             AS insertDate
	              FROM TBOT_POINT_RANK C
	             WHERE C.NEW_YN = '1'
	               AND C.CMD   = 'BAG_OPEN_SP'
	            UNION ALL
	            SELECT B.ITEM_NAME              AS gain,
	                   A.USER_NAME              AS userName,
	                   A.ROOM_NAME              AS roomName,
	                   A.INSERT_DATE            AS insertDate
	              FROM TBOT_POINT_NEW_INVENTORY A
	              JOIN TBOT_POINT_NEW_ITEM      B
	                ON A.ITEM_ID   = B.ITEM_ID
	             WHERE A.GAIN_TYPE = 'BAG_OPEN'
	        )
	        ORDER BY insertDate DESC
	    )
	    WHERE ROWNUM &lt;= 5
	</select>
	
	<select id="selectBagOpenSpCount" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	      FROM TBOT_POINT_RANK
	     WHERE NEW_YN = '1'
	       AND CMD = 'BAG_OPEN_SP'
	       AND USER_NAME = #{userName}
	       <!-- 
	       AND ROOM_NAME = #{roomName}
	        -->
	</select>

	<!-- ÏµúÍ∑º 5Í∞úÏùò BAG_OPEN_SP Ìï©Í≥Ñ -->
	<select id="selectRecentBagSpSum" parameterType="hashmap" resultType="int">
	    SELECT NVL(SUM(x.SCORE), 0) AS sumScore
	      FROM (
	            SELECT SCORE
	              FROM TBOT_POINT_RANK
	             WHERE NEW_YN   = '1'
	               AND CMD      = 'BAG_OPEN_SP'
	               AND USER_NAME = #{userName}
	               <!-- 
	               AND ROOM_NAME = #{roomName}
	                -->
	             ORDER BY INSERT_DATE DESC
	          ) x
	     WHERE ROWNUM &lt;= 10
	</select>
	
	<!-- DEL_YN='1' Ïù∏ Ïù∏Î≤§ÌÜ†Î¶¨ ÎàÑÏ†Å ÏàòÎüâ(ÌåêÎß§/ÏÇ¨Ïö© Ìè¨Ìï®) -->
	<select id="selectInventorySoldCount" resultType="int">
	  SELECT NVL(SUM(QTY), 0)
	  FROM TBOT_POINT_NEW_INVENTORY
	  WHERE USER_NAME = #{userName}
	  <!-- 
	  <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
	    AND ROOM_NAME = #{roomName}
	  </if>
	   -->
	  AND GAIN_TYPE IN ('DROP','DROP3','DROP5','STEAL')
	  AND NVL(DEL_YN, '0') = '1'
	</select>
	
	<select id="selectTotalGainCountByGainType"
	        resultType="hashmap">
	    SELECT GAIN_TYPE,
	           SUM(QTY) AS TOTAL_QTY
	    FROM   TBOT_POINT_NEW_INVENTORY
	    WHERE  USER_NAME = #{userName}
	    <!-- 
	      AND  ROOM_NAME = #{roomName}
	       -->
	      AND  GAIN_TYPE IN ('DROP3', 'DROP5')
	    GROUP BY GAIN_TYPE
	</select>
	
	<select id="selectJobSkillUseCount"
	        parameterType="map"
	        resultType="int">
	    SELECT NVL(SUM(job_skill_yn), 0) AS totalSkillUse
	      FROM TBOT_POINT_NEW_BATTLE_LOG
	     WHERE USER_NAME = #{userName}
	     <!-- 
	       AND ROOM_NAME = #{roomName}
	        -->
	       AND JOB       = #{job}
	</select>
	
	<select id="selectJobSkillUseCountAllJobs"
	        parameterType="map"
	        resultType="hashmap">
	    SELECT 
	        JOB                 AS JOB,
	        NVL(SUM(job_skill_yn), 0) AS TOTAL_SKILL_USE
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	    WHERE USER_NAME = #{userName}
	    <!-- 
	      AND ROOM_NAME = #{roomName}
	       -->
	    GROUP BY JOB
	</select>
	
	<select id="selectTodayDailyBuff" parameterType="hashmap" resultType="hashmap">
	    SELECT ATK_BONUS,
	           CRI_DMG_BONUS
	      FROM TBOT_POINT_NEW_DAILY_BUFF
	     WHERE USER_NAME = #{userName}
	     <!-- 
	       <if test="roomName != null and roomName != 'ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©'">
           AND ROOM_NAME = #{roomName}
         </if>
          -->
	       AND BUFF_DATE = TRUNC(SYSDATE)
	</select>
	
	<update id="upsertTodayDailyBuff" parameterType="hashmap">
	    MERGE INTO TBOT_POINT_NEW_DAILY_BUFF T
	    USING (
	        SELECT #{roomName} AS ROOM_NAME,
	               #{userName} AS USER_NAME,
	               TRUNC(SYSDATE) AS BUFF_DATE,
	               #{atkBonus} AS ATK_BONUS,
	               #{criDmgBonus} AS CRI_DMG_BONUS
	          FROM DUAL
	    ) S
	    ON ( <!--  T.ROOM_NAME = S.ROOM_NAME  AND --> T.USER_NAME = S.USER_NAME AND T.BUFF_DATE = S.BUFF_DATE)
	    WHEN MATCHED THEN
	        UPDATE SET T.ATK_BONUS     = S.ATK_BONUS,
	                   T.CRI_DMG_BONUS = S.CRI_DMG_BONUS,
	                   T.UPDATE_DATE   = SYSDATE
	    WHEN NOT MATCHED THEN
	        INSERT (ROOM_NAME, USER_NAME, BUFF_DATE, ATK_BONUS, CRI_DMG_BONUS, INSERT_DATE, UPDATE_DATE)
	        VALUES (S.ROOM_NAME, S.USER_NAME, S.BUFF_DATE, S.ATK_BONUS, S.CRI_DMG_BONUS, SYSDATE, SYSDATE)
	</update>
	
	<select id="countTodayJobMasterAll" resultType="int">
	    SELECT COUNT(1)
	      FROM TBOT_POINT_NEW_JOB_MASTER
	     WHERE MASTER_DATE = TRUNC(SYSDATE)
	</select>
	
	<update id="createTodayJobMastersFromYesterdayAll">
	    MERGE INTO TBOT_POINT_NEW_JOB_MASTER M
	    USING (
	        SELECT JOB,
	               TRUNC(SYSDATE) AS MASTER_DATE,
	               USER_NAME,
	               ATK_CNT
	          FROM (
	                SELECT JOB, USER_NAME, ATK_CNT,
	                       ROW_NUMBER() OVER(
	                           PARTITION BY JOB
	                           ORDER BY ATK_CNT DESC, USER_NAME ASC
	                       ) AS RN
	                  FROM (
	                        SELECT BL.JOB,
	                               BL.USER_NAME,
	                               COUNT(1) AS ATK_CNT
	                          FROM TBOT_POINT_NEW_BATTLE_LOG BL
	                         WHERE TRUNC(BL.INSERT_DATE) = TRUNC(SYSDATE) - 1
	                           AND BL.JOB IS NOT NULL
	                           AND BL.ROOM_NAME not in ('ÎûåÏ•êÎ¥á Î¨∏ÏùòÎ∞©','test123')
	                         GROUP BY BL.JOB, BL.USER_NAME
	                        HAVING COUNT(1) >50
	                       )
	               )
	         WHERE RN = 1
	    ) S
	    ON (M.JOB = S.JOB AND M.MASTER_DATE = S.MASTER_DATE)
	    WHEN NOT MATCHED THEN
	        INSERT (JOB, MASTER_DATE, USER_NAME, ATK_CNT, INSERT_DATE, UPDATE_DATE)
	        VALUES (S.JOB, S.MASTER_DATE, S.USER_NAME, S.ATK_CNT, SYSDATE, SYSDATE)
	</update>
	<select id="selectIsTodayJobMasterAll" parameterType="hashmap" resultType="int">
	    /*selectIsTodayJobMasterAll*/
	    SELECT COUNT(1)
	      FROM TBOT_POINT_NEW_JOB_MASTER
	     WHERE MASTER_DATE = TRUNC(SYSDATE)
	       AND JOB = #{job}
	       AND USER_NAME = #{userName}
	</select>
	
	<select id="selectTodayJobMastersAll" resultType="hashmap">
		/*selectIsTodayJobMasterAll*/
		SELECT JOB,
		       USER_NAME,
		       ATK_CNT
		  FROM TBOT_POINT_NEW_JOB_MASTER
		 WHERE MASTER_DATE = TRUNC(SYSDATE)
		 ORDER BY JOB ASC, ATK_CNT DESC
	</select>
	
	<select id="selectIsReturnUser" parameterType="map" resultType="string">
	    SELECT CASE
	             WHEN past_cnt >= 500
	              AND recent_cnt &lt;= 500
	              AND today_cnt >= 1
	             THEN 'Y'
	             ELSE 'N'
	           END AS IS_RETURN_USER
	    FROM (
	        SELECT
	            /* Í≥ºÍ±∞ ÌôúÎ∞ú */
	            (SELECT COUNT(*)
	               FROM TBOT_POINT_NEW_BATTLE_LOG
	              WHERE USER_NAME = #{userName}
	                AND INSERT_DATE >= TRUNC(SYSDATE) - 40
	                AND INSERT_DATE &lt;  TRUNC(SYSDATE) - 5
	            ) AS past_cnt,
	
	            /* ÏµúÍ∑º Ïπ®Ï≤¥ */
	            (SELECT COUNT(*)
	               FROM TBOT_POINT_NEW_BATTLE_LOG
	              WHERE USER_NAME = #{userName}
	                AND INSERT_DATE >= TRUNC(SYSDATE) - 5
	                AND INSERT_DATE &lt;  TRUNC(SYSDATE) - 2
	            ) AS recent_cnt,
	
	            /* Î≥µÍ∑Ä Ìä∏Î¶¨Í±∞ */
	            (SELECT COUNT(*)
	               FROM TBOT_POINT_NEW_BATTLE_LOG
	              WHERE USER_NAME = #{userName}
	                AND INSERT_DATE >= TRUNC(SYSDATE) - 2
	            ) AS today_cnt
	        FROM dual
	    )
	</select>
	
	<select id="selectBagRewardCap" parameterType="map" resultType="int">
	    SELECT
	        CASE
	            WHEN total_sp &lt; 5000000 THEN 50000
	            ELSE
	                50000
	                + TRUNC((total_sp - 5000000) / 1000000) * 10000
	        END AS BAG_REWARD_CAP
	    FROM (
	        SELECT
	            NVL(inv_sp, 0) + NVL(rank_sp, 0) AS total_sp
	        FROM
	            (
	                /* Ïù∏Î≤§ÌÜ†Î¶¨ Í∏∞Î∞ò ÎàÑÏ†Å SP */
	                SELECT
	                    SUM(
	                        CASE
	                            WHEN A.GAIN_TYPE = 'BUY_MERCHANT' THEN
	                                ROUND(B.ITEM_SELL_PRICE * 0.9) * A.QTY
	                            ELSE
	                                B.ITEM_SELL_PRICE * A.QTY
	                        END
	                    ) AS inv_sp
	                FROM TBOT_POINT_NEW_INVENTORY A
	                     JOIN TBOT_POINT_NEW_ITEM B
	                       ON A.ITEM_ID = B.ITEM_ID
	                WHERE A.GAIN_TYPE NOT IN ('DROP', 'DROP3', 'DROP5', 'STEAL')
	                  AND A.DEL_YN = '0'
	                  AND A.USER_NAME = #{userName}
	            ),
	            (
	                /* Îû≠ÌÇπ Í∏∞Î∞ò ÎàÑÏ†Å SP */
	                SELECT
	                    SUM(A1.SCORE) AS rank_sp
	                FROM TBOT_POINT_RANK A1
	                WHERE A1.NEW_YN = '1'
	                  AND A1.USER_NAME = #{userName}
	            )
	    )
	</select>
	
	<!-- ÎàÑÏ†Å ÎìúÎûç ÏïÑÏù¥ÌÖú ÏßëÍ≥Ñ -->
	<select id="selectTotalDropItems"
	        parameterType="map"
	        resultType="hashmap">
	        /*selectTotalDropItems*/
	    SELECT
	        I.ITEM_ID,
	        IT.ITEM_NAME,
	        I.GAIN_TYPE,
	        SUM(I.QTY) AS TOTAL_QTY
	    FROM TBOT_POINT_NEW_INVENTORY I
	    JOIN TBOT_POINT_NEW_ITEM IT
	      ON I.ITEM_ID = IT.ITEM_ID
	    WHERE I.USER_NAME = #{userName}
	      AND I.GAIN_TYPE IN ('DROP','DROP2','DROP3','DROP5','STEAL')
	      AND I.ITEM_ID &lt; 50
	    GROUP BY I.ITEM_ID, IT.ITEM_NAME, I.GAIN_TYPE
	    ORDER BY I.ITEM_ID DESC, I.GAIN_TYPE
	</select>

</mapper>
