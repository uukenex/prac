<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="my.prac.core.prjbot.dao.BotNewDAO">

  <insert id="insertBotPointNew" parameterType="HashMap">
    INSERT INTO TBOT_POINT_NEW
      (USER_NAME, ROOM_NAME, SCORE, INSERT_DATE, CMD)
    VALUES
      (#{userName,jdbcType=VARCHAR},
       #{roomName,jdbcType=VARCHAR},
       #{score,jdbcType=NUMERIC},
       SYSDATE,
       #{cmd,jdbcType=VARCHAR})
  </insert>

  <!-- 1) 유저 -->
  <select id="selectUser" resultType="my.prac.core.game.dto.User">
    SELECT USER_NAME, ROOM_NAME, LV, EXP_CUR, EXP_NEXT, HP_CUR, HP_MAX, HP_REGEN,
           ATK_MIN, ATK_MAX, CRIT_RATE, CRIT_DMG, TARGET_MON, INSERT_DATE
    FROM TBOT_POINT_NEW_USER
    WHERE USER_NAME = #{userName}
      AND ROOM_NAME = #{roomName}
  </select>

  <select id="selectAttackDeathStats" resultType="my.prac.core.game.dto.AttackDeathStat">
    SELECT
      COUNT(*) AS TOTAL_ATTACKS,
      SUM(CASE WHEN DEATH_YN = '1' THEN 1 ELSE 0 END) AS TOTAL_DEATHS
    FROM TBOT_POINT_NEW_BATTLE_LOG
    WHERE USER_NAME = #{userName}
      AND ROOM_NAME = #{roomName}
  </select>

  <select id="selectKillStats" resultType="my.prac.core.game.dto.KillStat">
    SELECT bl.TARGET_MON_LV AS MON_NO,
           m.MON_NAME AS MON_NAME,
           COUNT(*) AS KILL_COUNT
    FROM TBOT_POINT_NEW_BATTLE_LOG bl
    JOIN TBOT_POINT_NEW_MON_INFO m ON m.MON_NO = bl.TARGET_MON_LV
    WHERE bl.USER_NAME = #{userName}
      AND bl.ROOM_NAME = #{roomName}
      AND bl.KILL_YN = 1
    GROUP BY bl.TARGET_MON_LV, m.MON_NAME
    ORDER BY KILL_COUNT DESC, MON_NO ASC
  </select>

  <select id="selectAllMonsters" resultType="my.prac.core.game.dto.Monster">
    SELECT MON_NO, MON_NAME, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN
    FROM TBOT_POINT_NEW_MON_INFO
    ORDER BY MON_NO
  </select>

  <!-- 2) 몬스터 -->
  <select id="selectMonsterByNo" resultType="my.prac.core.game.dto.Monster">
    SELECT MON_NO, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_NAME
    FROM TBOT_POINT_NEW_MON_INFO
    WHERE MON_NO = #{monNo}
  </select>

  <select id="selectMonsterByName" resultType="my.prac.core.game.dto.Monster">
    SELECT MON_NO, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_NAME
    FROM TBOT_POINT_NEW_MON_INFO
    WHERE MON_NAME = #{monName}
  </select>

  <!-- 3) 진행중 전투 -->
  <select id="selectOngoingBattle" resultType="my.prac.core.game.dto.OngoingBattle">
    SELECT monNo, totalDealtDmg, luckyYn
      FROM (
        SELECT TARGET_MON_LV AS monNo,
               NVL(SUM(ATK_DMG), 0) AS totalDealtDmg,
               MAX(TO_NUMBER(LUCKY_YN)) KEEP (DENSE_RANK LAST ORDER BY INSERT_DATE) AS luckyYn,
               MAX(INSERT_DATE) AS lastTime
        FROM TBOT_POINT_NEW_BATTLE_LOG
        WHERE USER_NAME = #{userName}
          AND ROOM_NAME = #{roomName}
          AND NOW_YN    = '1'
        GROUP BY TARGET_MON_LV
        ORDER BY lastTime DESC
      )
     WHERE ROWNUM = 1
  </select>

  <!-- 4) 최신 공격 시간 -->
  <select id="selectLastAttackTime" resultType="java.sql.Timestamp">
    SELECT MAX(INSERT_DATE)
    FROM TBOT_POINT_NEW_BATTLE_LOG
    WHERE USER_NAME = #{userName}
      AND ROOM_NAME = #{roomName}
  </select>

  <!-- 5) 전투 후 유저 업데이트 -->
  <update id="updateUserAfterBattle">
    UPDATE TBOT_POINT_NEW_USER
       SET LV        = #{newLv},
           EXP_CUR   = #{newExpCur},
           EXP_NEXT  = #{newExpNext},
           HP_CUR    = #{newHpCur},
           HP_MAX    = #{newHpMax},
           ATK_MIN   = #{newAtkMin},
           ATK_MAX   = #{newAtkMax},
           CRIT_RATE = #{critRate},
           HP_REGEN  = #{hpRegen},
           PROC_DATE = SYSDATE
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
  </update>

  <!-- 6) 전투 로그 -->
  <insert id="insertBattleLog" parameterType="my.prac.core.game.dto.BattleLog">
    INSERT INTO TBOT_POINT_NEW_BATTLE_LOG
      (USER_NAME, ROOM_NAME, LV, TARGET_MON_LV,
       GAIN_EXP, ATK_DMG, MON_DMG, ATK_CRIT_YN,
       MON_PATTEN, INSERT_DATE, KILL_YN, NOW_YN, DROP_YN, DEATH_YN, LUCKY_YN)
    VALUES
      (#{userName}, #{roomName}, #{lv}, #{targetMonLv},
       #{gainExp}, #{atkDmg}, #{monDmg}, #{atkCritYn},
       #{monPatten}, SYSTIMESTAMP, #{killYn}, #{nowYn}, #{dropYn}, #{deathYn}, #{luckyYn})
  </insert>

  <!-- 7) 전투 종료 -->
  <update id="closeOngoingBattle">
    UPDATE TBOT_POINT_NEW_BATTLE_LOG
       SET NOW_YN = '0'
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
       AND NOW_YN    = '1'
  </update>

  <!-- HP만 갱신 -->
  <update id="updateUserHpOnly">
    UPDATE TBOT_POINT_NEW_USER
       SET HP_CUR = #{newHpCur}
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
  </update>

  <update id="updateUserTargetMon">
    UPDATE TBOT_POINT_NEW_USER
       SET TARGET_MON = #{newMonNo}
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
  </update>

  <insert id="insertUserWithTarget">
    INSERT INTO TBOT_POINT_NEW_USER
      (USER_NAME, ROOM_NAME, LV, EXP_CUR, EXP_NEXT,
       HP_CUR, HP_MAX, HP_REGEN, ATK_MIN, ATK_MAX,
       CRIT_RATE, CRIT_DMG, INSERT_DATE, TARGET_MON)
    VALUES
      (#{userName}, #{roomName},
       1, 0, 100,
       10, 10, 1,
       1, 5,
       10, 150,
       SYSDATE, #{targetMonNo})
  </insert>

  <!-- 보조 닉네임 검색 -->
  <select id="selectParam1ToNewUserSearch" parameterType="HashMap" resultType="String">
    SELECT A.USER_NAME
      FROM TBOT_POINT_NEW_USER A
     WHERE UPPER(A.USER_NAME) LIKE UPPER(#{param1,jdbcType=VARCHAR}) || '%'
       AND A.ROOM_NAME = #{roomName,jdbcType=VARCHAR}
       AND NOT EXISTS (
           SELECT 1 FROM TBOT_BLOCK C
            WHERE UPPER(C.USER_NAME) = UPPER(#{param1,jdbcType=VARCHAR})
              AND C.ROOM_NAME = A.ROOM_NAME
       )
     GROUP BY A.USER_NAME, A.ROOM_NAME
    HAVING 1 = CASE WHEN MAX(A.PROC_DATE) >= TRUNC(SYSDATE) - 3 THEN 1 ELSE 0 END
     ORDER BY CASE WHEN LENGTH(#{param1,jdbcType=VARCHAR}) = LENGTH(A.USER_NAME) THEN 1 ELSE 0 END DESC
  </select>

  <!-- 최근 lucky -->
  <select id="selectLatestLuckyYn" parameterType="map" resultType="int">
    SELECT TO_NUMBER(lucky_yn) AS lucky_yn
      FROM (
        SELECT bl.lucky_yn
          FROM TBOT_POINT_NEW_BATTLE_LOG bl
         WHERE bl.user_name = #{userName}
           AND bl.room_name = #{roomName}
           AND bl.now_yn    = '1'
         ORDER BY bl.insert_date DESC
      )
     WHERE ROWNUM = 1
  </select>

  <!-- 아이템 -->
  <select id="selectItemIdByCode" resultType="int">
    SELECT ITEM_ID FROM TBOT_POINT_NEW_ITEM WHERE ITEM_CODE = #{itemCode}
  </select>

  <!-- (중복 제거하고 이 한 개만 남김) -->
  <select id="selectItemIdByName" parameterType="string" resultType="int">
    SELECT ITEM_ID FROM TBOT_POINT_NEW_ITEM WHERE ITEM_NAME = #{itemName}
  </select>

  <insert id="insertInventoryLog" parameterType="hashmap">
    INSERT INTO TBOT_POINT_NEW_INVENTORY
      (USER_NAME, ROOM_NAME, ITEM_ID, QTY, DEL_YN, GAIN_TYPE, INSERT_DATE)
    VALUES
      (#{userName,jdbcType=VARCHAR},
       #{roomName,jdbcType=VARCHAR},
       #{itemId,jdbcType=NUMERIC},
       #{qty,jdbcType=NUMERIC},
       NVL(#{delYn,jdbcType=VARCHAR}, '0'),
       #{gainType,jdbcType=VARCHAR},
       SYSDATE)
  </insert>

  <!-- 일반 요약(판매가능/불가 분리 용) -->
  <select id="selectInventorySummary" resultType="hashmap">
    SELECT
	    x.ITEM_ID,
	    CASE WHEN x.GAIN_TYPE = 'DROP3'
	         THEN '✨빛' || NVL(t.ITEM_NAME, '알 수 없음')
	         ELSE NVL(t.ITEM_NAME, '알 수 없음')
	    END AS ITEM_NAME,
	    '1' AS SELLABLE_YN,             -- 빛템도 판매 가능
	    x.TOTAL_QTY
	  FROM (
	    SELECT ITEM_ID, GAIN_TYPE, SUM(QTY) AS TOTAL_QTY
	      FROM TBOT_POINT_NEW_INVENTORY
	     WHERE USER_NAME = #{userName}
	       AND ROOM_NAME = #{roomName}
	       AND DEL_YN    = '0'
	     GROUP BY ITEM_ID, GAIN_TYPE
	  ) x
	  LEFT JOIN TBOT_POINT_NEW_ITEM t ON t.ITEM_ID = x.ITEM_ID
	 WHERE x.TOTAL_QTY > 0
	 ORDER BY NVL(t.ITEM_NAME, 'ZZZ'), x.ITEM_ID
  </select>

  <select id="selectInventorySummaryAll" resultType="hashmap">
	  SELECT
	      NVL(i.item_id, -1) AS ITEM_ID,
	      CASE 
	        WHEN NVL(inv.gain_type,'DROP') = 'DROP3'
	          THEN '빛' || NVL(i.item_name, '알 수 없음')
	        ELSE NVL(i.item_name, '알 수 없음')
	      END AS ITEM_NAME,
	      SUM(inv.qty) AS TOTAL_QTY,
	      NVL(MAX(i.item_sell_price), 0) AS ITEM_SELL_PRICE,
	      NVL(MAX(i.item_type), '')      AS ITEM_TYPE
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  LEFT JOIN TBOT_POINT_NEW_ITEM i
	    ON i.item_id = inv.item_id
	  WHERE inv.user_name = #{userName}
	    AND inv.room_name = #{roomName}
	    AND inv.del_yn = '0'
	  GROUP BY
	      NVL(i.item_id, -1),
	      CASE 
	        WHEN NVL(inv.gain_type,'DROP') = 'DROP3'
	          THEN '빛' || NVL(i.item_name, '알 수 없음')
	        ELSE NVL(i.item_name, '알 수 없음')
	      END
	  ORDER BY NVL(i.item_id, -1)
	</select>

  <select id="selectCurrentPoint" resultType="int">
    SELECT NVL(SUM(score), 0)
      FROM TBOT_POINT_RANK
     WHERE user_name = #{userName}
       AND room_name = #{roomName}
       AND new_yn = '1'
  </select>

  <!-- 판매 대상 행(FIFO) : 빛나는 제외 -->
  <select id="selectInventoryRowsForSale" resultType="hashmap">
    SELECT ROWID AS RID, QTY, NVL(GAIN_TYPE,'DROP') AS GAIN_TYPE
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
       AND ITEM_ID   = #{itemId}
       AND NVL(DEL_YN,'0') != '1'
     ORDER BY INSERT_DATE ASC, ROWID
  </select>

  <update id="updateInventoryDelByRowId">
    UPDATE TBOT_POINT_NEW_INVENTORY SET DEL_YN = '1' WHERE ROWID = #{rid}
  </update>

  <update id="updateInventoryQtyByRowId">
    UPDATE TBOT_POINT_NEW_INVENTORY SET QTY = #{newQty} WHERE ROWID = #{rid}
  </update>


  <select id="selectItemSellPriceById" resultType="int">
    SELECT NVL(ITEM_SELL_PRICE,0)
      FROM TBOT_POINT_NEW_ITEM
     WHERE ITEM_ID = #{itemId}
  </select>

  <!-- 포인트 적립 -->
  <insert id="insertPointRank" parameterType="hashmap">
    INSERT INTO TBOT_POINT_RANK
      (USER_NAME, ROOM_NAME, SCORE, INSERT_DATE, CMD, NEW_YN)
    VALUES
      (#{userName}, #{roomName}, #{score}, SYSDATE, #{cmd}, '1')
  </insert>

  <select id="selectItemPriceByName" parameterType="string" resultType="int">
    SELECT NVL(item_sell_price,0)
      FROM TBOT_POINT_NEW_ITEM
     WHERE item_name = #{itemName}
  </select>

  <!-- 보유 아이템 능력치 총합 (DEL_YN='0') -->
  <select id="selectOwnedItemBuffTotals" resultType="hashmap">
    SELECT
        NVL(SUM(i.atk_min),0)  AS ATK_MIN,
        NVL(SUM(i.atk_max),0)  AS ATK_MAX,
        NVL(SUM(i.atk_cri),0)  AS ATK_CRI,
        NVL(SUM(i.hp_regen),0) AS HP_REGEN,
        NVL(SUM(i.hp_max),0)   AS HP_MAX
    FROM TBOT_POINT_NEW_INVENTORY inv
    JOIN TBOT_POINT_NEW_ITEM i
      ON i.item_id = inv.item_id
    WHERE inv.user_name = #{userName}
      AND inv.room_name = #{roomName}
      AND inv.del_yn = '0'
      <if test="onlyMarket != null and onlyMarket == 'Y'">
        AND i.item_type = 'MARKET'
      </if>
  </select>
  
  <select id="selectOwnedMarketBuffTotals" resultType="map">
	  SELECT
	      NVL(SUM(i.atk_min),0)   AS ATK_MIN,
	      NVL(SUM(i.atk_max),0)   AS ATK_MAX,
	      NVL(SUM(i.atk_cri),0)   AS ATK_CRI,
	      NVL(SUM(i.hp_regen),0)  AS HP_REGEN,
	      NVL(SUM(i.hp_max),0)    AS HP_MAX,
	      NVL(SUM(i.cri_dmg),0) AS CRI_DMG
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  JOIN TBOT_POINT_NEW_ITEM i
	    ON i.item_id = inv.item_id
	  WHERE inv.user_name = #{userName}
	    AND inv.room_name = #{roomName}
	    AND inv.del_yn = '0'
	    AND i.item_type = 'MARKET'
	</select>
	
	<!-- 전체(필요시) -->
	<select id="selectOwnedAllBuffTotals" resultType="map">
	  SELECT
	      NVL(SUM(i.atk_min),0)   AS ATK_MIN,
	      NVL(SUM(i.atk_max),0)   AS ATK_MAX,
	      NVL(SUM(i.atk_cri),0)   AS ATK_CRI,
	      NVL(SUM(i.hp_regen),0)  AS HP_REGEN,
	      NVL(SUM(i.hp_max),0)    AS HP_MAX,
	      NVL(SUM(i.cri_dmg),0) AS CRI_DMG
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  JOIN TBOT_POINT_NEW_ITEM i
	    ON i.item_id = inv.item_id
	  WHERE inv.user_name = #{userName}
	    AND inv.room_name = #{roomName}
	    AND inv.del_yn = '0'
	    /* 전체라서 item_type 조건 없음 */
	</select>
	
	<!-- 구매 가능한 MARKET 아이템 목록 + 보유여부 -->
	<select id="selectMarketItemsForSale" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.item_desc,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg,
	      CASE
	        WHEN EXISTS (
	          SELECT 1
	            FROM TBOT_POINT_NEW_INVENTORY inv
	           WHERE inv.user_name = #{userName}
	             AND inv.room_name = #{roomName}
	             AND inv.item_id   = i.item_id
	             AND inv.del_yn    = '0'
	        ) THEN 'Y' ELSE 'N'
	      END AS owned_yn
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	  ORDER BY i.item_id
	</select>
	
	<!-- MARKET 단일: ITEM_ID 기준 -->
	<select id="selectMarketItemById" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.item_desc,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	    AND i.item_id   = #{itemId}
	</select>
	
	<!-- MARKET 단일: 이름 또는 코드 기준 (두 칼럼 모두 매칭 시 우선 한 건) -->
	<select id="selectMarketItemByNameOrCode" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.item_desc,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	    AND (i.item_name = #{token} OR i.item_code = #{token})
	</select>
	
	<!-- 보유중인 MARKET 인벤토리 수량(활성행) -->
	<select id="countOwnedMarketItem" resultType="int">
	  SELECT NVL(SUM(inv.qty),0)
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  WHERE inv.user_name = #{userName}
	    AND inv.room_name = #{roomName}
	    AND inv.item_id   = #{itemId}
	    AND inv.del_yn    = '0'
	</select>
	
	
	<select id="selectMarketItems" resultType="hashmap">
	    SELECT 
	        i.ITEM_ID,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,   0) AS ATK_MIN,
	        NVL(i.ATK_MAX,   0) AS ATK_MAX,
	        NVL(i.ATK_CRI,   0) AS ATK_CRI,
	        NVL(i.HP_REGEN,  0) AS HP_REGEN,
	        NVL(i.HP_MAX,    0) AS HP_MAX,
	        NVL(i.CRI_DMG,   0) AS CRI_DMG
	    FROM TBOT_POINT_NEW_ITEM i
	    WHERE i.ITEM_TYPE = 'MARKET'
	    ORDER BY i.ITEM_ID
	</select>
	
	<!--  B. 아이템 단건 상세  -->
	<select id="selectItemDetailById" resultType="hashmap">
	    SELECT 
	        i.ITEM_ID,
	        i.ITEM_CODE,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_DESC,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,   0) AS ATK_MIN,
	        NVL(i.ATK_MAX,   0) AS ATK_MAX,
	        NVL(i.ATK_CRI,   0) AS ATK_CRI,
	        NVL(i.HP_REGEN,  0) AS HP_REGEN,
	        NVL(i.HP_MAX,    0) AS HP_MAX,
	        NVL(i.CRI_DMG,   0) AS CRI_DMG
	    FROM TBOT_POINT_NEW_ITEM i
	    WHERE i.ITEM_ID = #{itemId}
	</select>
	
	
	<!--  D. 인벤토리 보유 수량 합(DEL_YN='0'만)  -->
	<select id="selectInventoryQty" resultType="int">
	    SELECT NVL(SUM(n.QTY), 0)
	    FROM TBOT_POINT_NEW_INVENTORY n
	    WHERE n.USER_NAME = #{userName}
	      AND n.ROOM_NAME = #{roomName}
	      AND n.ITEM_ID   = #{itemId}
	      AND NVL(n.DEL_YN, '0') = '0'
	</select>
	<!-- MARKET 아이템 전체 + 보유여부(OWNED_YN) -->
	<select id="selectMarketItemsWithOwned" resultType="hashmap">
	  SELECT
	      i.ITEM_ID,
	      i.ITEM_NAME,
	      i.ITEM_SELL_PRICE,
	      i.ITEM_TYPE,
	      NVL(i.ATK_MIN,0)  AS ATK_MIN,
	      NVL(i.ATK_MAX,0)  AS ATK_MAX,
	      NVL(i.ATK_CRI,0)  AS ATK_CRI,
	      NVL(i.HP_REGEN,0) AS HP_REGEN,
	      NVL(i.HP_MAX,0)   AS HP_MAX,
	      NVL(i.CRI_DMG,   0) AS CRI_DMG,
	      CASE
	        WHEN EXISTS (
	          SELECT 1
	            FROM TBOT_POINT_NEW_INVENTORY inv
	           WHERE inv.USER_NAME = #{userName}
	             AND inv.ROOM_NAME = #{roomName}
	             AND inv.ITEM_ID   = i.ITEM_ID
	             AND inv.DEL_YN    = '0'
	        ) THEN 'Y' ELSE 'N'
	      END AS OWNED_YN
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.ITEM_TYPE = 'MARKET'
	  ORDER BY i.ITEM_ID
	</select>
	
	<!-- 이미 소유한 MARKET 아이템인지 확인 -->
	<select id="selectHasOwnedMarketItem" resultType="int">
	  SELECT COUNT(1)
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  WHERE inv.USER_NAME = #{userName}
	    AND inv.ROOM_NAME = #{roomName}
	    AND inv.ITEM_ID   = #{itemId}
	    AND inv.DEL_YN    = '0'
	</select>
	
	<!-- 마지막으로 '피해를 받은' 시각: MON_DMG>0 또는 DEATH_YN='1' -->
	<select id="selectLastDamagedTime" resultType="java.sql.Timestamp">
	  SELECT MAX(INSERT_DATE)
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	   WHERE USER_NAME = #{userName}
	     AND ROOM_NAME = #{roomName}
	     AND (MON_DMG > 0 OR DEATH_YN = '1')
	</select>
	
	<select id="selectTopLevelUsers" resultType="hashmap">
	  SELECT USER_NAME, LV, EXP_CUR, EXP_NEXT
	  FROM (
	    SELECT u.USER_NAME, u.LV, u.EXP_CUR, u.EXP_NEXT,
	           ROW_NUMBER() OVER (ORDER BY u.LV DESC, u.EXP_CUR DESC, u.USER_NAME ASC) AS RN
	      FROM TBOT_POINT_NEW_USER u
	  )
	  WHERE RN &lt;= 3
	  ORDER BY RN
	</select>
	
	<!-- ② 몬스터별 학살자 (킬 50 이상, 동률 허용) -->
	<select id="selectKillLeadersByMonster" resultType="hashmap">
	  SELECT MON_NO, MON_NAME, USER_NAME, KILL_COUNT
	  FROM (
	    SELECT
	      bl.TARGET_MON_LV AS MON_NO,
	      m.MON_NAME       AS MON_NAME,
	      bl.USER_NAME     AS USER_NAME,
	      COUNT(*)         AS KILL_COUNT,
	      DENSE_RANK() OVER (
	        PARTITION BY bl.TARGET_MON_LV
	        ORDER BY COUNT(*) DESC
	      ) AS RNK
	    FROM TBOT_POINT_NEW_BATTLE_LOG bl
	    JOIN TBOT_POINT_NEW_MON_INFO m
	      ON m.MON_NO = bl.TARGET_MON_LV
	    WHERE bl.KILL_YN   = 1
	    GROUP BY bl.TARGET_MON_LV, m.MON_NAME, bl.USER_NAME
	  )
	  WHERE RNK = 1
	    AND KILL_COUNT >= 50
	  ORDER BY MON_NO, USER_NAME
	</select>
	
	<!-- ③ 최초 토벌자 정보 -->
	<select id="selectFirstClearInfo" resultType="hashmap">
	  SELECT
	      m.MON_NO,
	      m.MON_NAME,
	      fc.FIRST_CLEAR_USER,
	      TO_CHAR(fc.FIRST_CLEAR_DATE, 'YYYY-MM-DD HH24:MI') AS FIRST_CLEAR_DATE
	  FROM TBOT_POINT_NEW_MON_INFO m
	  LEFT JOIN (
	    SELECT
	        bl.TARGET_MON_LV AS MON_NO,
	        MIN(bl.INSERT_DATE) AS FIRST_CLEAR_DATE,
	        MIN(bl.USER_NAME) KEEP (DENSE_RANK FIRST ORDER BY bl.INSERT_DATE) AS FIRST_CLEAR_USER
	    FROM TBOT_POINT_NEW_BATTLE_LOG bl
	    WHERE bl.KILL_YN = 1
	    GROUP BY bl.TARGET_MON_LV
	  ) fc ON fc.MON_NO = m.MON_NO
	  WHERE fc.FIRST_CLEAR_USER IS NOT NULL
	  ORDER BY m.MON_NO
	</select>
	
</mapper>
