<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="my.prac.core.prjbot.dao.BotNewDAO">

  <!-- 1) 유저 -->
  <select id="selectUser" resultType="my.prac.core.game.dto.User">
	  SELECT *
	  FROM (
	      SELECT USER_NAME,
	             ROOM_NAME,
	             LV,
	             EXP_CUR,
	             EXP_NEXT,
	             HP_CUR,
	             HP_MAX,
	             HP_REGEN,
	             ATK_MIN,
	             ATK_MAX,
	             CRIT_RATE,
	             CRIT_DMG,
	             TARGET_MON,
	             INSERT_DATE,
	             JOB,
	             JOB_CHANGE_DATE
	      FROM TBOT_POINT_NEW_USER
	      WHERE USER_NAME = #{userName}
	        <!-- 문의방이 아니면 기존처럼 roomName 고정 -->
	        <if test="roomName != null and roomName != '람쥐봇 문의방'">
	          AND ROOM_NAME = #{roomName}
	        </if>
	      ORDER BY
	          PROC_DATE DESC NULLS LAST,
	          INSERT_DATE DESC NULLS LAST,
	          LV DESC,
	          EXP_CUR DESC
	  )
	  WHERE ROWNUM = 1
	</select>

  <select id="selectAttackDeathStats" resultType="my.prac.core.game.dto.AttackDeathStat">
  /*selectAttackDeathStats*/
    SELECT
      COUNT(*) AS TOTAL_ATTACKS,
      SUM(CASE WHEN DEATH_YN = '1' THEN 1 ELSE 0 END) AS TOTAL_DEATHS
    FROM TBOT_POINT_NEW_BATTLE_LOG
    WHERE USER_NAME = #{userName}
    <if test="roomName != null and roomName != '람쥐봇 문의방'">
      AND ROOM_NAME = #{roomName}
    </if>
  </select>

  <select id="selectKillStats" resultType="my.prac.core.game.dto.KillStat">
  /*selectKillStats*/
    SELECT bl.TARGET_MON_LV AS MON_NO,
           m.MON_NAME AS MON_NAME,
           COUNT(*) AS KILL_COUNT
    FROM TBOT_POINT_NEW_BATTLE_LOG bl
    JOIN TBOT_POINT_NEW_MON_INFO m ON m.MON_NO = bl.TARGET_MON_LV
    WHERE bl.USER_NAME = #{userName}
      <if test="roomName != null and roomName != '람쥐봇 문의방'">
	    AND bl.ROOM_NAME = #{roomName}
	  </if>
      AND bl.KILL_YN = 1
    GROUP BY bl.TARGET_MON_LV, m.MON_NAME
    ORDER BY MON_NO DESC
  </select>

  <select id="selectAllMonsters" resultType="my.prac.core.game.dto.Monster">
    SELECT MON_NO, MON_NAME, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_LV,MON_NOTE
    FROM TBOT_POINT_NEW_MON_INFO
    ORDER BY MON_NO
  </select>

  <!-- 2) 몬스터 -->
  <select id="selectMonsterByNo" resultType="my.prac.core.game.dto.Monster">
  /*selectMonsterByNo*/
    SELECT MON_NO, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_NAME, MON_LV,MON_NOTE
    FROM TBOT_POINT_NEW_MON_INFO
    WHERE MON_NO = #{monNo}
  </select>

  <select id="selectMonsterByName" resultType="my.prac.core.game.dto.Monster">
  /*selectMonsterByName*/
    SELECT MON_NO, MON_HP, MON_ATK, MON_EXP, MON_DROP, MON_PATTEN, MON_NAME, MON_LV,MON_NOTE
    FROM TBOT_POINT_NEW_MON_INFO
    WHERE MON_NAME = #{monName}
  </select>

  <!-- 3) 진행중 전투 -->
  <select id="selectOngoingBattle" resultType="my.prac.core.game.dto.OngoingBattle">
    SELECT monNo, totalDealtDmg, luckyYn,beforeJobSkillYn
      FROM (
        SELECT TARGET_MON_LV AS monNo,
               NVL(SUM(ATK_DMG), 0) AS totalDealtDmg,
               MAX(TO_NUMBER(LUCKY_YN)) KEEP (DENSE_RANK LAST ORDER BY INSERT_DATE) AS luckyYn,
               MAX(JOB_SKILL_YN) KEEP (DENSE_RANK LAST ORDER BY INSERT_DATE) AS beforeJobSkillYn,
               MAX(INSERT_DATE) AS lastTime
        FROM TBOT_POINT_NEW_BATTLE_LOG
        WHERE USER_NAME = #{userName}
          AND ROOM_NAME = #{roomName}
          AND NOW_YN    = '1'
        GROUP BY TARGET_MON_LV
        ORDER BY lastTime DESC
      )
     WHERE ROWNUM = 1
  </select>

  <!-- 4) 최신 공격 시간 -->
  <select id="selectLastAttackTime" resultType="java.sql.Timestamp">
    SELECT MAX(INSERT_DATE)
    FROM TBOT_POINT_NEW_BATTLE_LOG
    WHERE USER_NAME = #{userName}
      AND ROOM_NAME = #{roomName}
  </select>

  <!-- 5) 전투 후 유저 업데이트 -->
  <update id="updateUserAfterBattle">
    UPDATE TBOT_POINT_NEW_USER
       SET LV        = #{newLv},
           EXP_CUR   = #{newExpCur},
           EXP_NEXT  = #{newExpNext},
           HP_CUR    = #{newHpCur},
           HP_MAX    = #{newHpMax},
           ATK_MIN   = #{newAtkMin},
           ATK_MAX   = #{newAtkMax},
           CRIT_RATE = #{critRate},
           HP_REGEN  = #{hpRegen},
           PROC_DATE = SYSDATE
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
  </update>

  <!-- 6) 전투 로그 -->
  <insert id="insertBattleLog" parameterType="my.prac.core.game.dto.BattleLog">
    INSERT INTO TBOT_POINT_NEW_BATTLE_LOG
      (USER_NAME, ROOM_NAME, LV, TARGET_MON_LV,
       GAIN_EXP, ATK_DMG, MON_DMG, ATK_CRIT_YN,
       MON_PATTEN, INSERT_DATE, KILL_YN, NOW_YN, DROP_YN, DEATH_YN, LUCKY_YN, BUFF_YN
       ,JOB_SKILL_YN,JOB
       )
    VALUES
      (#{userName}, #{roomName}, #{lv}, #{targetMonLv},
       #{gainExp}, #{atkDmg}, #{monDmg}, #{atkCritYn},
       #{monPatten}, SYSTIMESTAMP, #{killYn}, #{nowYn}, #{dropYn}, #{deathYn}, #{luckyYn},#{buffYn}
       ,#{jobSkillYn},#{job}
       )
  </insert>

  <!-- 7) 전투 종료 -->
  <update id="closeOngoingBattle">
    UPDATE TBOT_POINT_NEW_BATTLE_LOG
       SET NOW_YN = '0'
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
       AND NOW_YN    = '1'
  </update>

  <!-- HP만 갱신 -->
  <update id="updateUserHpOnly">
    UPDATE TBOT_POINT_NEW_USER
       SET HP_CUR = #{newHpCur}
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
  </update>

  <update id="updateUserTargetMon">
    UPDATE TBOT_POINT_NEW_USER
       SET TARGET_MON = #{newMonNo}
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
  </update>

  <insert id="insertUserWithTarget">
    INSERT INTO TBOT_POINT_NEW_USER
      (USER_NAME, ROOM_NAME, LV, EXP_CUR, EXP_NEXT,
       HP_CUR, HP_MAX, HP_REGEN, ATK_MIN, ATK_MAX,
       CRIT_RATE, CRIT_DMG, INSERT_DATE, TARGET_MON)
    VALUES
      (#{userName}, #{roomName},1, 0, 100,
       10, 10, 2, 1, 5,
       10, 150, SYSDATE, #{targetMonNo})
  </insert>

  <!-- 보조 닉네임 검색 -->
  <select id="selectParam1ToNewUserSearch" parameterType="HashMap" resultType="String">
	  SELECT A.USER_NAME
	    FROM TBOT_POINT_NEW_USER A
	   WHERE UPPER(A.USER_NAME) LIKE UPPER(#{param1,jdbcType=VARCHAR}) || '%'
	     <!-- 문의방이 아닐 때만 방 고정 -->
	     <if test="roomName != null and roomName != '람쥐봇 문의방'">
	       AND A.ROOM_NAME = #{roomName,jdbcType=VARCHAR}
	     </if>
	     AND NOT EXISTS (
	         SELECT 1
	           FROM TBOT_BLOCK C
	          WHERE UPPER(C.USER_NAME) = UPPER(#{param1,jdbcType=VARCHAR})
	            <!-- 블록 체크도 동일 방 기준 (문의방이면 전체에 대해 해당 닉/방 조합 기준으로 동작) -->
	            <if test="roomName != null and roomName != '람쥐봇 문의방'">
	              AND C.ROOM_NAME = A.ROOM_NAME
	            </if>
	     )
	   GROUP BY A.USER_NAME, A.ROOM_NAME
	  HAVING 1 = CASE WHEN MAX(A.PROC_DATE) >= TRUNC(SYSDATE) - 3 THEN 1 ELSE 0 END
	   ORDER BY CASE WHEN LENGTH(#{param1,jdbcType=VARCHAR}) = LENGTH(A.USER_NAME) THEN 1 ELSE 0 END DESC
	</select>

  <!-- 최근 lucky -->
  <select id="selectLatestLuckyYn" parameterType="map" resultType="int">
    SELECT TO_NUMBER(lucky_yn) AS lucky_yn
      FROM (
        SELECT bl.lucky_yn
          FROM TBOT_POINT_NEW_BATTLE_LOG bl
         WHERE bl.user_name = #{userName}
           AND bl.room_name = #{roomName}
           AND bl.now_yn    = '1'
         ORDER BY bl.insert_date DESC
      )
     WHERE ROWNUM = 1
  </select>

  <!-- 아이템 -->
  <select id="selectItemIdByCode" resultType="int">
    SELECT ITEM_ID FROM TBOT_POINT_NEW_ITEM WHERE ITEM_CODE = #{itemCode}
  </select>

  <!-- (중복 제거하고 이 한 개만 남김) -->
  <select id="selectItemIdByName" parameterType="string" resultType="int">
    SELECT ITEM_ID FROM TBOT_POINT_NEW_ITEM WHERE ITEM_NAME = #{itemName}
  </select>

  <insert id="insertInventoryLog" parameterType="hashmap">
    INSERT INTO TBOT_POINT_NEW_INVENTORY
      (USER_NAME, ROOM_NAME, ITEM_ID, QTY, DEL_YN, GAIN_TYPE, INSERT_DATE)
    VALUES
      (#{userName,jdbcType=VARCHAR},
       #{roomName,jdbcType=VARCHAR},
       #{itemId,jdbcType=NUMERIC},
       #{qty,jdbcType=NUMERIC},
       NVL(#{delYn,jdbcType=VARCHAR}, '0'),
       #{gainType,jdbcType=VARCHAR},
       SYSDATE)
  </insert>

  <!-- 일반 요약(판매가능/불가 분리 용) -->
  <select id="selectInventorySummary" resultType="hashmap">
    /*selectInventorySummary*/
    SELECT
	    x.ITEM_ID,
	    CASE WHEN x.GAIN_TYPE = 'DROP3'
	         THEN '빛' || NVL(t.ITEM_NAME, '알 수 없음')
	         WHEN x.GAIN_TYPE = 'DROP5'
	         THEN '어둠' || NVL(t.ITEM_NAME, '알 수 없음')
	         WHEN x.GAIN_TYPE = 'STEAL'
    		 THEN NVL(t.ITEM_NAME, '알 수 없음') || '조각'
	         ELSE NVL(t.ITEM_NAME, '알 수 없음')
	    END AS ITEM_NAME,
	    '1' AS SELLABLE_YN,             -- 빛템도 판매 가능
	    x.TOTAL_QTY
	  FROM (
	    SELECT ITEM_ID, GAIN_TYPE, SUM(QTY) AS TOTAL_QTY
	      FROM TBOT_POINT_NEW_INVENTORY
	     WHERE USER_NAME = #{userName}
	       <if test="roomName != null and roomName != '람쥐봇 문의방'">
		    AND ROOM_NAME = #{roomName}
		   </if>
	       AND DEL_YN    = '0'
	     GROUP BY ITEM_ID, GAIN_TYPE
	  ) x
	  LEFT JOIN TBOT_POINT_NEW_ITEM t ON t.ITEM_ID = x.ITEM_ID
	 WHERE x.TOTAL_QTY > 0
	 ORDER BY NVL(t.ITEM_NAME, 'ZZZ'), x.ITEM_ID
  </select>

  <select id="selectInventorySummaryAll" resultType="hashmap">
  /*selectInventorySummaryAll*/
	  SELECT
	      NVL(i.item_id, -1) AS ITEM_ID,
	      CASE 
	        WHEN NVL(inv.gain_type,'DROP') = 'DROP3'
	          THEN '빛' || NVL(i.item_name, '알 수 없음')
	        WHEN NVL(inv.gain_type,'DROP') = 'DROP5'
	          THEN '어둠' || NVL(i.item_name, '알 수 없음')
	        WHEN NVL(inv.gain_type,'DROP') = 'STEAL'
          	  THEN NVL(i.item_name, '알 수 없음') || '조각'
	        ELSE NVL(i.item_name, '알 수 없음')
	      END AS ITEM_NAME,
	      SUM(inv.qty) AS TOTAL_QTY,
	      NVL(MAX(i.item_sell_price), 0) AS ITEM_SELL_PRICE,
	      NVL(MAX(i.item_type), '')      AS ITEM_TYPE
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  LEFT JOIN TBOT_POINT_NEW_ITEM i
	    ON i.item_id = inv.item_id
	  WHERE inv.user_name = #{userName}
	   <if test="roomName != null and roomName != '람쥐봇 문의방'">
	    AND inv.room_name = #{roomName}
	  </if>
	    AND inv.del_yn = '0'
	  GROUP BY
	      NVL(i.item_id, -1),
	      CASE 
	        WHEN NVL(inv.gain_type,'DROP') = 'DROP3'
	          THEN '빛' || NVL(i.item_name, '알 수 없음')
	        WHEN NVL(inv.gain_type,'DROP') = 'DROP5'
	          THEN '어둠' || NVL(i.item_name, '알 수 없음')
	        WHEN NVL(inv.gain_type,'DROP') = 'STEAL'
          	  THEN NVL(i.item_name, '알 수 없음') || '조각'
          	ELSE NVL(i.item_name, '알 수 없음')
	      END
	  ORDER BY NVL(i.item_id, -1)
	</select>

  <select id="selectCurrentPoint" resultType="int">
    SELECT NVL(SUM(score), 0)
      FROM TBOT_POINT_RANK
     WHERE user_name = #{userName}
     <if test="roomName != null and roomName != '람쥐봇 문의방'">
	   AND room_name = #{roomName}
	 </if>
       
       AND new_yn = '1'
  </select>

  <!-- 판매 대상 행(FIFO) : 빛나는 제외 -->
  <select id="selectInventoryRowsForSale" resultType="hashmap">
    SELECT ROWID AS RID, QTY, NVL(GAIN_TYPE,'DROP') AS GAIN_TYPE
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
       AND ITEM_ID   = #{itemId}
       AND NVL(DEL_YN,'0') != '1'
     ORDER BY INSERT_DATE ASC, ROWID
  </select>
  <!-- 판매 대상 행(FIFO) : 빛나는 제외 -->
  <select id="selectAllInventoryRowsForSale" resultType="hashmap">
    SELECT ROWID AS RID, QTY, NVL(GAIN_TYPE,'DROP') AS GAIN_TYPE
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
       AND NVL(DEL_YN,'0') != '1'
     ORDER BY INSERT_DATE ASC, ROWID
  </select>

  <update id="updateInventoryDelByRowId">
    UPDATE TBOT_POINT_NEW_INVENTORY SET DEL_YN = '1' WHERE ROWID = #{rid}
  </update>

  <update id="updateInventoryQtyByRowId">
    UPDATE TBOT_POINT_NEW_INVENTORY SET QTY = #{newQty} WHERE ROWID = #{rid}
  </update>


  <select id="selectItemSellPriceById" resultType="int">
    SELECT NVL(ITEM_SELL_PRICE,0)
      FROM TBOT_POINT_NEW_ITEM
     WHERE ITEM_ID = #{itemId}
  </select>

  <!-- 포인트 적립 -->
  <insert id="insertPointRank" parameterType="hashmap">
    INSERT INTO TBOT_POINT_RANK
      (USER_NAME, ROOM_NAME, SCORE, INSERT_DATE, CMD, NEW_YN)
    VALUES
      (#{userName}, #{roomName}, #{score}, SYSDATE, #{cmd}, '1')
  </insert>

  <select id="selectItemPriceByName" parameterType="string" resultType="int">
    SELECT NVL(item_sell_price,0)
      FROM TBOT_POINT_NEW_ITEM
     WHERE item_name = #{itemName}
  </select>

  
  <select id="selectOwnedMarketBuffTotals" resultType="map">
	  SELECT
	      	NVL(SUM( ROUND(i.atk_min  * 
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6            -- qty >= 4
		        END
		    )), 0) AS ATK_MIN,
		    NVL(SUM( ROUND(i.atk_max  * 
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS ATK_MAX,
		    NVL(SUM( ROUND(i.atk_cri  *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS ATK_CRI,
		    NVL(SUM( ROUND(i.hp_regen *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS HP_REGEN,
		    NVL(SUM( ROUND(i.hp_max   *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS HP_MAX,
		    NVL(SUM( ROUND(i.cri_dmg  *
		        CASE 
		            WHEN inv.qty = 1 THEN 1.0
		            WHEN inv.qty =  2 THEN 1.3
		            WHEN inv.qty =  3 THEN 1.5
		            ELSE 1.6
		        END
		    )), 0) AS CRI_DMG
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  JOIN TBOT_POINT_NEW_ITEM i
	    ON i.item_id = inv.item_id
	  WHERE inv.user_name = #{userName}
	    <if test="roomName != null and roomName != '람쥐봇 문의방'">
	    AND inv.room_name = #{roomName}
	  </if>
	    AND inv.del_yn = '0'
	    AND i.item_type in ('MARKET','BAG_OPEN','MASTER')
	</select>
	
	<!-- 구매 가능한 MARKET 아이템 목록 + 보유여부 -->
	<select id="selectMarketItemsForSale" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.item_desc,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg,
	      CASE
	        WHEN EXISTS (
	          SELECT 1
	            FROM TBOT_POINT_NEW_INVENTORY inv
	           WHERE inv.user_name = #{userName}
	             AND inv.room_name = #{roomName}
	             AND inv.item_id   = i.item_id
	             AND inv.del_yn    = '0'
	        ) THEN 'Y' ELSE 'N'
	      END AS owned_yn
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	  ORDER BY i.item_id
	</select>
	
	<!-- MARKET 단일: ITEM_ID 기준 -->
	<select id="selectMarketItemById" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.item_desc,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	    AND i.item_id   = #{itemId}
	</select>
	
	<!-- MARKET 단일: 이름 또는 코드 기준 (두 칼럼 모두 매칭 시 우선 한 건) -->
	<select id="selectMarketItemByNameOrCode" resultType="hashmap">
	  SELECT
	      i.item_id,
	      i.item_name,
	      i.item_sell_price,
	      i.item_desc,
	      i.atk_min,
	      i.atk_max,
	      i.atk_cri,
	      i.hp_regen,
	      i.hp_max,
	      i.cri_dmg
	  FROM TBOT_POINT_NEW_ITEM i
	  WHERE i.item_type = 'MARKET'
	    AND (i.item_name = #{token} OR i.item_code = #{token})
	</select>
	
	<!-- 보유중인 MARKET 인벤토리 수량(활성행) -->
	<select id="countOwnedMarketItem" resultType="int">
	  SELECT NVL(SUM(inv.qty),0)
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  WHERE inv.user_name = #{userName}
	    AND inv.room_name = #{roomName}
	    AND inv.item_id   = #{itemId}
	    AND inv.del_yn    = '0'
	</select>
	
	
	<select id="selectMarketItems" resultType="hashmap">
	    SELECT 
	        i.ITEM_ID,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,   0) AS ATK_MIN,
	        NVL(i.ATK_MAX,   0) AS ATK_MAX,
	        NVL(i.ATK_CRI,   0) AS ATK_CRI,
	        NVL(i.HP_REGEN,  0) AS HP_REGEN,
	        NVL(i.HP_MAX,    0) AS HP_MAX,
	        NVL(i.CRI_DMG,   0) AS CRI_DMG
	    FROM TBOT_POINT_NEW_ITEM i
	    WHERE i.ITEM_TYPE = 'MARKET'
	    ORDER BY i.ITEM_ID
	</select>
	
	<!--  B. 아이템 단건 상세  -->
	<select id="selectItemDetailById" resultType="hashmap">
	    SELECT 
	        i.ITEM_ID,
	        i.ITEM_CODE,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_DESC,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,   0) AS ATK_MIN,
	        NVL(i.ATK_MAX,   0) AS ATK_MAX,
	        NVL(i.ATK_CRI,   0) AS ATK_CRI,
	        NVL(i.HP_REGEN,  0) AS HP_REGEN,
	        NVL(i.HP_MAX,    0) AS HP_MAX,
	        NVL(i.CRI_DMG,   0) AS CRI_DMG
	    FROM TBOT_POINT_NEW_ITEM i
	    WHERE i.ITEM_ID = #{itemId}
	</select>
	
	
	<!--  D. 인벤토리 보유 수량 합(DEL_YN='0'만)  -->
	<select id="selectInventoryQty" resultType="int">
	    SELECT NVL(SUM(n.QTY), 0)
	    FROM TBOT_POINT_NEW_INVENTORY n
	    WHERE n.USER_NAME = #{userName}
	      AND n.ROOM_NAME = #{roomName}
	      AND n.ITEM_ID   = #{itemId}
	      AND NVL(n.DEL_YN, '0') = '0'
	</select>
	<!-- MARKET 아이템 전체 + 보유여부(OWNED_YN) -->
	<select id="selectMarketItemsWithOwned" resultType="hashmap">
	    SELECT
	        i.ITEM_ID,
	        i.ITEM_NAME,
	        i.ITEM_SELL_PRICE,
	        i.ITEM_TYPE,
	        NVL(i.ATK_MIN,0)   AS ATK_MIN,
	        NVL(i.ATK_MAX,0)   AS ATK_MAX,
	        NVL(i.ATK_CRI,0)   AS ATK_CRI,
	        NVL(i.HP_REGEN,0)  AS HP_REGEN,
	        NVL(i.HP_MAX,0)    AS HP_MAX,
	        NVL(i.CRI_DMG,0)   AS CRI_DMG,
	
	        NVL(inv.OWN_QTY, 0) AS OWN_QTY,
	
	        CASE WHEN NVL(inv.OWN_QTY, 0) > 0 THEN 'Y' ELSE 'N' END AS OWNED_YN,
	
	        CASE
	            WHEN i.ITEM_ID BETWEEN 100 AND 199
	              OR i.ITEM_ID BETWEEN 200 AND 299
	              OR i.ITEM_ID BETWEEN 400 AND 499
	            THEN
	                CASE
	                    WHEN NVL(inv.OWN_QTY, 0) >= 4 THEN 'Y'  
	                    ELSE 'N'
	                END
	            ELSE
	                CASE
	                    WHEN NVL(inv.OWN_QTY, 0) >= 1 THEN 'Y'
	                    ELSE 'N'
	                END
	        END AS MAXED_YN,
	        I.INSERT_DATE
	
	    FROM TBOT_POINT_NEW_ITEM i
	
	    LEFT JOIN (
	        SELECT
	            inv.ITEM_ID,
	            inv.USER_NAME,
	            inv.ROOM_NAME,
	            SUM(inv.QTY) AS OWN_QTY
	        FROM TBOT_POINT_NEW_INVENTORY inv
	        WHERE inv.DEL_YN = '0'
	        GROUP BY inv.ITEM_ID, inv.USER_NAME, inv.ROOM_NAME
	    ) inv
	      ON inv.ITEM_ID   = i.ITEM_ID
	     AND inv.USER_NAME = #{userName}
	     <if test="roomName != null and roomName != '람쥐봇 문의방'">
	       AND inv.ROOM_NAME = #{roomName}
	     </if>
	
	    WHERE i.ITEM_TYPE = 'MARKET'
	    ORDER BY i.ITEM_ID
	</select>

	
	<!-- 이미 소유한 MARKET 아이템인지 확인 -->
	<select id="selectHasOwnedMarketItem" resultType="int">
	  SELECT COUNT(1)
	  FROM TBOT_POINT_NEW_INVENTORY inv
	  WHERE inv.USER_NAME = #{userName}
	 	<if test="roomName != null and roomName != '람쥐봇 문의방'">
	    AND inv.ROOM_NAME = #{roomName}
	   </if>
	    AND inv.ITEM_ID   = #{itemId}
	    AND inv.DEL_YN    = '0'
	</select>
	
	<!-- 마지막으로 '피해를 받은' 시각: MON_DMG>0 또는 DEATH_YN='1' -->
	<select id="selectLastDamagedTime" resultType="java.sql.Timestamp">
	  SELECT MAX(
	           INSERT_DATE
	           + CASE 
	               WHEN DEATH_YN = '1' 
	                 THEN (5 / 24 / 60)  -- 10분 = 10/24/60 일
	               ELSE 0
	             END
	         )
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	   WHERE USER_NAME = #{userName}
	   <if test="roomName != null and roomName != '람쥐봇 문의방'">
	     AND ROOM_NAME = #{roomName}
	   </if>
	     AND (MON_DMG > 0 OR DEATH_YN = '1')
	</select>
	
	<select id="selectTopLevelUsers" resultType="hashmap">
	  SELECT USER_NAME, LV, EXP_CUR, EXP_NEXT, JOB
	  FROM (
	    SELECT u.USER_NAME, u.LV, u.EXP_CUR, u.EXP_NEXT, U.JOB,
	           ROW_NUMBER() OVER (ORDER BY u.LV DESC, u.EXP_CUR DESC, u.USER_NAME ASC) AS RN
	      FROM TBOT_POINT_NEW_USER u
	      WHERE U.PROC_DATE > SYSDATE-3
	  )
	  WHERE RN &lt;= 7
	  ORDER BY RN
	</select>
	
	<!-- ② 몬스터별 학살자 (킬 50 이상, 동률 허용) -->
	<select id="selectKillLeadersByMonster" resultType="hashmap">
	  SELECT MON_NO, MON_NAME, USER_NAME, KILL_COUNT
	  FROM (
	    SELECT
	      bl.TARGET_MON_LV AS MON_NO,
	      m.MON_NAME       AS MON_NAME,
	      bl.USER_NAME     AS USER_NAME,
	      COUNT(*)         AS KILL_COUNT,
	      DENSE_RANK() OVER (
	        PARTITION BY bl.TARGET_MON_LV
	        ORDER BY COUNT(*) DESC
	      ) AS RNK
	    FROM TBOT_POINT_NEW_BATTLE_LOG bl
	    JOIN TBOT_POINT_NEW_MON_INFO m
	      ON m.MON_NO = bl.TARGET_MON_LV
	    WHERE bl.KILL_YN   = 1
	    GROUP BY bl.TARGET_MON_LV, m.MON_NAME, bl.USER_NAME
	  )
	  WHERE RNK = 1
	    AND KILL_COUNT >= 50
	  ORDER BY MON_NO, USER_NAME
	</select>
	
	<!-- ③ 최초 토벌자 정보 -->
	<select id="selectFirstClearInfo" resultType="hashmap">
	  SELECT
	      m.MON_NO,
	      m.MON_NAME,
	      m.MON_LV,
	      fc.FIRST_CLEAR_USER,
	      TO_CHAR(fc.FIRST_CLEAR_DATE, 'YYYY-MM-DD HH24:MI') AS FIRST_CLEAR_DATE
	  FROM TBOT_POINT_NEW_MON_INFO m
	  LEFT JOIN (
	    SELECT
	        bl.TARGET_MON_LV AS MON_NO,
	        MIN(bl.INSERT_DATE) AS FIRST_CLEAR_DATE,
	        MIN(bl.USER_NAME) KEEP (DENSE_RANK FIRST ORDER BY bl.INSERT_DATE) AS FIRST_CLEAR_USER
	    FROM TBOT_POINT_NEW_BATTLE_LOG bl
	    WHERE bl.KILL_YN = 1
	    GROUP BY bl.TARGET_MON_LV
	  ) fc ON fc.MON_NO = m.MON_NO
	  WHERE fc.FIRST_CLEAR_USER IS NOT NULL
	  ORDER BY m.MON_NO
	</select>
	
	
	
		<!-- 특정 방에서 특정 유저가 특정 업적 CMD로 이미 보상받았는지 -->
	<select id="selectPointRankCountByCmdUserInRoom" parameterType="hashMap" resultType="int">
	    SELECT COUNT(1)
	    FROM TBOT_POINT_RANK
	    WHERE ROOM_NAME = #{roomName}
	      AND USER_NAME = #{userName}
	      AND CMD = #{cmd}
	      AND NEW_YN = '1'
	</select>
	
	<select id="selectPointRankCountByCmdGlobal" resultType="int">
	/*selectPointRankCountByCmdGlobal*/
	   SELECT COUNT(1)
	     FROM TBOT_POINT_RANK
	    WHERE CMD = #{cmd}
	      AND NEW_YN = '1'
	</select>
	<select id="selectAchvCountsGlobalAll" resultType="my.prac.core.game.dto.AchievementCount">
	    /*selectAchvCountsGlobalAll*/
	    SELECT CMD,
	           COUNT(1) AS CNT
	      FROM TBOT_POINT_RANK
	     WHERE NEW_YN = '1'
	       AND CMD LIKE 'ACHV_%'
	     GROUP BY CMD
	</select>
	
	<select id="selectAchievementsByUser" resultType="hashMap" parameterType="string">
	/*selectAchievementsByUser*/
	  SELECT CMD, SCORE, USER_NAME, ROOM_NAME, INSERT_DATE
	  FROM TBOT_POINT_RANK
	  WHERE USER_NAME = #{userName}
	   <if test="roomName != null and roomName != '람쥐봇 문의방'">
        AND ROOM_NAME = #{roomName}
      </if>
	    AND CMD LIKE 'ACHV_%'
	  ORDER BY CASE
			        WHEN CMD LIKE 'ACHV_FIRST_CLEAR_MON_%' THEN 1
			        WHEN CMD LIKE 'ACHV_KILL_TOTAL_%'      THEN 2
			        WHEN CMD LIKE 'ACHV_KILL%_MON_%'       THEN 3
			        WHEN CMD LIKE 'ACHV_DEATH%'       	   THEN 4
			        ELSE 9
			    END,
			    -- 2순위: 몬스터번호 or 총킬조건 숫자(각 패턴에 맞게)
			    CASE
			        WHEN CMD LIKE 'ACHV_FIRST_CLEAR_MON_%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))
			        WHEN CMD LIKE 'ACHV_KILL_TOTAL_%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))
			        WHEN CMD LIKE 'ACHV_KILL%_MON_%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))  -- MON_뒤 숫자 (몬스터 번호)
			        WHEN CMD LIKE 'ACHV_DEATH%'
			             THEN -TO_NUMBER(REGEXP_SUBSTR(CMD, '[0-9]+$'))
			        ELSE NULL
			    END,
			    -- 3순위: 같은 MON에서 50 → 100 순
			    CASE
			        WHEN CMD LIKE 'ACHV_KILL50_MON_%'  THEN 1
			        WHEN CMD LIKE 'ACHV_KILL100_MON_%' THEN 2
			        ELSE 0
			    END
	</select>
	
	
	<update id="updateUserJobAndChangeDate">
	/*updateUserJobAndChangeDate*/
	    UPDATE TBOT_POINT_NEW_USER
	       SET JOB = #{job},
	           JOB_CHANGE_DATE = SYSDATE
	     WHERE USER_NAME = #{userName}
	       AND ROOM_NAME = #{roomName}
	</update>
	
	<select id="selectRisingStarsTop5Last6h" resultType="hashmap">
	/*selectRisingStarsTop5Last6h*/
	    SELECT *
	    FROM (
	        SELECT USER_NAME,
	               ROOM_NAME,
	               (SELECT U.JOB
					   FROM TBOT_POINT_NEW_USER U
					  WHERE U.USER_NAME = A.USER_NAME
					    AND ROWNUM=1) AS JOB,
	               COUNT(*) AS ATK_CNT,
	               MAX(INSERT_DATE) AS LAST_ATTACK
	        FROM TBOT_POINT_NEW_BATTLE_LOG A
	        WHERE INSERT_DATE >= SYSDATE - (3/24)
	        GROUP BY USER_NAME, ROOM_NAME
	        ORDER BY ATK_CNT DESC, LAST_ATTACK DESC
	    )
	    WHERE ROWNUM &lt;= 8
	</select>
	
	<select id="selectSpAndAtkRanking" resultType="hashmap">
	    SELECT SUM(
	               CASE
	                   WHEN A.GAIN_TYPE = 'BUY_MERCHANT' THEN
	                       ROUND(B.ITEM_SELL_PRICE * 0.9) * A.QTY
	                   ELSE
	                       B.ITEM_SELL_PRICE * A.QTY
	               END
	           )
	           + (
	               SELECT SUM(A1.SCORE)
	                 FROM TBOT_POINT_RANK A1
	                WHERE A1.NEW_YN    = '1'
	                  AND A1.USER_NAME = A.USER_NAME
	                  AND A1.ROOM_NAME = A.ROOM_NAME
	             ) AS TOT_SP,
	           A.USER_NAME,
	           A.ROOM_NAME,
	           (
	               SELECT COUNT(1)
	                 FROM TBOT_POINT_NEW_BATTLE_LOG A2
	                WHERE A2.USER_NAME = A.USER_NAME
	                  AND A2.ROOM_NAME = A.ROOM_NAME
	           ) AS ATK_CNT,
	           C.LV
	      FROM TBOT_POINT_NEW_INVENTORY A,
	           TBOT_POINT_NEW_ITEM      B,
	           TBOT_POINT_NEW_USER      C
	     WHERE A.GAIN_TYPE NOT IN ('DROP', 'DROP3', 'DROP5', 'STEAL')
	       AND A.ITEM_ID   = B.ITEM_ID
	       AND A.DEL_YN    = '0'
	       AND C.USER_NAME = A.USER_NAME
	       AND C.ROOM_NAME = A.ROOM_NAME
	     GROUP BY A.USER_NAME, A.ROOM_NAME, C.LV
	     ORDER BY TOT_SP DESC
	</select>
	
	<select id="selectOngoingChallengesForUnclearedBosses" resultType="hashmap">
	/*selectOngoingChallengesForUnclearedBosses*/
	  SELECT
	      ob.TARGET_MON_LV          AS MON_NO,
	      m.MON_NAME                AS MON_NAME,
	      ob.USER_NAME              AS USER_NAME,
	      u.JOB                     AS JOB,
	      u.LV                      AS LV,
	      TO_CHAR(ob.START_TIME, 'YYYY-MM-DD HH24:MI:SS') AS START_TIME,
	      m.MON_HP                  AS MON_HP,
	      GREATEST(m.MON_HP - ob.TOTAL_ATK, 0) AS REMAIN_HP
	  FROM (
	      SELECT
	          bl.USER_NAME,
	          bl.ROOM_NAME,
	          bl.TARGET_MON_LV,
	          MIN(bl.INSERT_DATE)         AS START_TIME,
	          NVL(SUM(bl.ATK_DMG), 0)     AS TOTAL_ATK
	      FROM TBOT_POINT_NEW_BATTLE_LOG bl
	      WHERE bl.NOW_YN = '1'
	      GROUP BY bl.USER_NAME, bl.ROOM_NAME, bl.TARGET_MON_LV
	  ) ob
	  JOIN TBOT_POINT_NEW_MON_INFO m
	    ON m.MON_NO = ob.TARGET_MON_LV
	  JOIN TBOT_POINT_NEW_USER u
	    ON u.USER_NAME = ob.USER_NAME
	   AND u.ROOM_NAME = ob.ROOM_NAME
	  WHERE NOT EXISTS (
	        SELECT 1
	          FROM TBOT_POINT_NEW_BATTLE_LOG b2
	         WHERE b2.TARGET_MON_LV = ob.TARGET_MON_LV
	           AND b2.KILL_YN = 1
	    )
	  ORDER BY m.MON_NO, ob.START_TIME, ob.USER_NAME
	</select>
	
	<!-- 도사 버프 확인 (방 전체 1회용 버프 존재 여부) -->
	<select id="selectRoomBuffCount" parameterType="string" resultType="int">
	    SELECT COUNT(1)
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	    WHERE ROOM_NAME = #{roomName}
	      AND BUFF_YN = '1'
	</select>
	
	<!-- 도사 버프 리셋 (1회 사용 후 0으로 초기화) -->
	<update id="clearRoomBuff" parameterType="string">
	    UPDATE TBOT_POINT_NEW_BATTLE_LOG
	       SET BUFF_YN = '0'
	     WHERE ROOM_NAME = #{roomName}
	       AND BUFF_YN = '1'
	</update>
	
	<select id="selectDosaBuffInfo" parameterType="string" resultType="hashmap">
	    /*selectDosaBuffInfo*/
	    SELECT USER_NAME,
	           LV,
	           INSERT_DATE
	      FROM TBOT_POINT_NEW_BATTLE_LOG
	     WHERE ROOM_NAME = #{roomName}
	       AND BUFF_YN = '1'
	       and rownum=1
	     ORDER BY INSERT_DATE DESC
	</select>
	
	<select id="selectItemIdByRowId" parameterType="string" resultType="int">
	    SELECT ITEM_ID
	      FROM TBOT_POINT_NEW_INVENTORY
	     WHERE ROWID = #{rid}
	</select>
	
	<select id="selectTotalEarnedSp" resultType="int">
	SELECT (SELECT SUM(A.SCORE)
	          FROM TBOT_POINT_RANK A
	         WHERE A.NEW_YN = '1'
	           AND A.USER_NAME = #{userName}
	           <if test="roomName != null and roomName != '람쥐봇 문의방'">
	           AND ROOM_NAME = #{roomName}
	           </if>
	           
	           ) +
	       (SELECT SUM(CASE
	                     WHEN A.GAIN_TYPE = 'BUY_MERCHANT' THEN
	                      ROUND(B.ITEM_SELL_PRICE * 0.9)*A.QTY
	                     ELSE
	                      B.ITEM_SELL_PRICE*A.QTY
	                   END)
	          FROM TBOT_POINT_NEW_INVENTORY A, TBOT_POINT_NEW_ITEM B
	         WHERE A.USER_NAME LIKE #{userName}
	         <if test="roomName != null and roomName != '람쥐봇 문의방'">
	           AND ROOM_NAME = #{roomName}
	         </if>
	           AND A.GAIN_TYPE NOT IN ('DROP', 'DROP3','DROP5', 'STEAL')
	           AND A.ITEM_ID = B.ITEM_ID
	           AND DEL_YN = '0')
	  FROM DUAL
	  </select>
	  
	  <select id="selectThiefKingRanking" parameterType="string" resultType="hashmap">
	    SELECT *
	    FROM (
	        SELECT USER_NAME,
	               ROOM_NAME,
	               SUM(QTY) AS STEAL_QTY
	          FROM TBOT_POINT_NEW_INVENTORY
	         WHERE NVL(GAIN_TYPE, 'DROP') = 'STEAL'
	         GROUP BY USER_NAME, ROOM_NAME
	         ORDER BY SUM(QTY) DESC, USER_NAME
	    )
	    WHERE ROWNUM &lt;= 5
	</select>
	
	
	<select id="selectAchievementCountRanking" parameterType="string" resultType="hashmap">
	    SELECT *
		    FROM (
		        SELECT USER_NAME,
		               ROOM_NAME,
		               COUNT(*) AS ACHV_CNT
		          FROM TBOT_POINT_RANK
		         WHERE NEW_YN = '1'
		           AND CMD LIKE 'ACHV%'
		         GROUP BY USER_NAME, ROOM_NAME
		         ORDER BY COUNT(*) DESC, USER_NAME
		    )
		    WHERE ROWNUM &lt;= 5
	</select>
	
	<select id="selectActiveMonster" parameterType="hashmap" resultType="hashmap">
	  SELECT *
	    FROM (
	        SELECT 
	               b.TARGET_MON_LV,
	               mi.MON_NAME,
	               mi.MON_HP       AS MON_MAX_HP
	          FROM TBOT_POINT_NEW_BATTLE_LOG b
	          JOIN TBOT_POINT_NEW_MON_INFO mi
	            ON b.TARGET_MON_LV = mi.MON_NO     <!-- 몬스터 레벨/번호 매핑 -->
	         WHERE b.USER_NAME = #{userName}
	           AND b.ROOM_NAME = #{roomName}
	           AND NVL(b.NOW_YN, '1') = '1'        <!-- 현재 진행중 전투 -->
	           AND NVL(b.KILL_YN, '0') = '0'       <!-- 아직 안 죽은 몬스터 -->
	         ORDER BY b.INSERT_DATE DESC           <!-- 가장 최근 전투 로그 -->
	    )
	    WHERE ROWNUM = 1
	</select>
	
	<select id="selectAchvCountsGlobal" resultType="my.prac.core.game.dto.AchievementCount">
	    SELECT CMD,
	           COUNT(1) AS CNT
	      FROM TBOT_POINT_RANK
	     WHERE NEW_YN = '1'
	       <if test="roomName != null and roomName != '람쥐봇 문의방'">
           AND ROOM_NAME = #{roomName}
	       </if>
	       AND USER_NAME = #{userName}
	       AND CMD LIKE 'ACHV_%'
	     GROUP BY CMD
	</select>
	
	<update id="execSPMsgTest" statementType="CALLABLE" parameterType="hashMap">
		{call SP_MSG_TEST ( #{outCode  , jdbcType=NUMERIC,mode=INOUT},
						 	#{outMsg   , jdbcType=VARCHAR,mode=INOUT}
							)
		}
	</update>
	<update id="execSPPatchNoteTest" statementType="CALLABLE" parameterType="hashMap">
		{call SP_PATCH_NOTE_TEST ( #{outCode  , jdbcType=NUMERIC,mode=INOUT},
								   #{outMsg   , jdbcType=VARCHAR,mode=INOUT}
								  )
		}
	</update>
		
		
	<select id="selectBagCount" resultType="int">
    SELECT NVL(SUM(QTY), 0)
      FROM TBOT_POINT_NEW_INVENTORY
     WHERE USER_NAME = #{userName}
       AND ROOM_NAME = #{roomName}
       AND ITEM_ID   = #{itemId}
       AND DEL_YN    = '0'
	</select>
	
	<!-- 2) 가방 1개 소비: 가장 먼저 들어온 1개를 del_yn='1'로 -->
	<update id="consumeOneBag" parameterType="hashmap">
	    UPDATE TBOT_POINT_NEW_INVENTORY
	       SET DEL_YN = '1'
	     WHERE USER_NAME = #{userName}
	       AND ROOM_NAME = #{roomName}
	       AND ITEM_ID   = #{itemId}
	       AND DEL_YN    = '0'
	       AND ROWNUM    = 1
	</update>
	
	<select id="selectBagRewardItemIds" resultType="int">
	    SELECT ITEM_ID
	      FROM TBOT_POINT_NEW_ITEM
	     WHERE ITEM_TYPE = 'SELL'
	</select>
	
	<!-- 4) 아이템 이름 조회 -->
	<select id="selectItemNameById" resultType="string">
	    SELECT ITEM_NAME
	      FROM TBOT_POINT_NEW_ITEM
	     WHERE ITEM_ID = #{itemId}
	</select>
	
	<select id="selectBagRewardItemIdsUserNotOwned" parameterType="hashmap" resultType="int">
    SELECT ITEM_ID
      FROM TBOT_POINT_NEW_ITEM I
     WHERE I.ITEM_TYPE = 'BAG_OPEN'
       AND I.ITEM_ID NOT IN (
           SELECT DISTINCT ITEM_ID
             FROM TBOT_POINT_NEW_INVENTORY
            WHERE USER_NAME = #{userName}
              AND ROOM_NAME = #{roomName}
              AND DEL_YN = '0'
       )
	</select>

	<select id="selectRecentBagDrops" resultType="my.prac.core.game.dto.BagLog">
	    SELECT *
		  FROM (
		      SELECT 
		          USER_NAME AS userName,
		          ROOM_NAME AS roomName,
		          INSERT_DATE AS insertDate
		      FROM TBOT_POINT_NEW_INVENTORY
		      WHERE ITEM_ID = 91     -- 가방
		      ORDER BY INSERT_DATE DESC
		  )
		  WHERE ROWNUM &lt;= 5
	</select>
	
	<select id="selectRecentBagRewards"
        resultType="my.prac.core.game.dto.BagRewardLog">
	    SELECT *
	    FROM (
	        SELECT gain,
	               userName,
	               roomName,
	               insertDate
	        FROM (
	            SELECT TO_CHAR(C.SCORE) || ' sp' AS gain,
	                   C.USER_NAME               AS userName,
	                   C.ROOM_NAME               AS roomName,
	                   C.INSERT_DATE             AS insertDate
	              FROM TBOT_POINT_RANK C
	             WHERE C.NEW_YN = '1'
	               AND C.CMD   = 'BAG_OPEN_SP'
	            UNION ALL
	            SELECT B.ITEM_NAME              AS gain,
	                   A.USER_NAME              AS userName,
	                   A.ROOM_NAME              AS roomName,
	                   A.INSERT_DATE            AS insertDate
	              FROM TBOT_POINT_NEW_INVENTORY A
	              JOIN TBOT_POINT_NEW_ITEM      B
	                ON A.ITEM_ID   = B.ITEM_ID
	             WHERE A.GAIN_TYPE = 'BAG_OPEN'
	        )
	        ORDER BY insertDate DESC
	    )
	    WHERE ROWNUM &lt;= 5
	</select>
	
	<select id="selectBagOpenSpCount" parameterType="hashmap" resultType="int">
	    SELECT COUNT(*)
	      FROM TBOT_POINT_RANK
	     WHERE NEW_YN = '1'
	       AND CMD = 'BAG_OPEN_SP'
	       AND USER_NAME = #{userName}
	       AND ROOM_NAME = #{roomName}
	</select>

	<!-- 최근 5개의 BAG_OPEN_SP 합계 -->
	<select id="selectRecentBagSpSum" parameterType="hashmap" resultType="int">
	    SELECT NVL(SUM(x.SCORE), 0) AS sumScore
	      FROM (
	            SELECT SCORE
	              FROM TBOT_POINT_RANK
	             WHERE NEW_YN   = '1'
	               AND CMD      = 'BAG_OPEN_SP'
	               AND USER_NAME = #{userName}
	               AND ROOM_NAME = #{roomName}
	             ORDER BY INSERT_DATE DESC
	          ) x
	     WHERE ROWNUM &lt;= 10
	</select>
	
	<!-- DEL_YN='1' 인 인벤토리 누적 수량(판매/사용 포함) -->
	<select id="selectInventorySoldCount" resultType="int">
	  SELECT NVL(SUM(QTY), 0)
	  FROM TBOT_POINT_NEW_INVENTORY
	  WHERE USER_NAME = #{userName}
	  <if test="roomName != null and roomName != '람쥐봇 문의방'">
	    AND ROOM_NAME = #{roomName}
	  </if>
	  AND GAIN_TYPE IN ('DROP','DROP3','DROP5','STEAL')
	  AND NVL(DEL_YN, '0') = '1'
	</select>
	
	<select id="selectTotalGainCountByGainType"
	        resultType="hashmap">
	    SELECT GAIN_TYPE,
	           SUM(QTY) AS TOTAL_QTY
	    FROM   TBOT_POINT_NEW_INVENTORY
	    WHERE  USER_NAME = #{userName}
	      AND  ROOM_NAME = #{roomName}
	      AND  GAIN_TYPE IN ('DROP3', 'DROP5')
	    GROUP BY GAIN_TYPE
	</select>
	
	<select id="selectJobSkillUseCount"
	        parameterType="map"
	        resultType="int">
	    SELECT NVL(SUM(job_skill_yn), 0) AS totalSkillUse
	      FROM TBOT_POINT_NEW_BATTLE_LOG
	     WHERE USER_NAME = #{userName}
	       AND ROOM_NAME = #{roomName}
	       AND JOB       = #{job}
	</select>
	
	<select id="selectJobSkillUseCountAllJobs"
	        parameterType="map"
	        resultType="hashmap">
	    SELECT 
	        JOB                 AS JOB,
	        NVL(SUM(job_skill_yn), 0) AS TOTAL_SKILL_USE
	    FROM TBOT_POINT_NEW_BATTLE_LOG
	    WHERE USER_NAME = #{userName}
	      AND ROOM_NAME = #{roomName}
	    GROUP BY JOB
	</select>
	
</mapper>
